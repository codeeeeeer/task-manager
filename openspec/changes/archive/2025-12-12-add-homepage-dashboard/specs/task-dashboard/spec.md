# Task Dashboard Specification

## ADDED Requirements

### Requirement: 任务统计概览
系统SHALL在首页提供任务统计概览，展示关键任务指标的实时数据。

#### Scenario: 查看任务总体统计
- **WHEN** 用户访问首页
- **THEN** 系统显示以下统计数据：
  - 总任务数
  - 待响应任务数
  - 处理中任务数
  - 已完成任务数

#### Scenario: 统计数据实时更新
- **WHEN** 任务状态发生变化（通过WebSocket推送）
- **THEN** 首页统计数据自动更新，无需手动刷新

### Requirement: 任务状态分布可视化
系统SHALL提供任务状态分布的可视化图表，帮助用户快速了解任务状态分布情况。

#### Scenario: 查看状态分布图表
- **WHEN** 用户访问首页
- **THEN** 系统显示任务状态分布图表（饼图或柱状图），包含各状态的任务数量和占比

#### Scenario: 图表交互
- **WHEN** 用户点击图表中的某个状态
- **THEN** 系统跳转到任务列表页面，并自动筛选该状态的任务

### Requirement: 任务分类分布统计
系统SHALL展示不同任务分类的数量分布，帮助用户了解任务类型构成。

#### Scenario: 查看分类统计
- **WHEN** 用户访问首页
- **THEN** 系统显示各任务分类（版本任务、紧急任务、普通任务、定时周期任务、其他任务）的数量统计

### Requirement: 我的待办任务列表
系统SHALL在首页展示当前用户的待办任务，方便用户快速查看和处理。

#### Scenario: 查看我的待办任务
- **WHEN** 用户访问首页
- **THEN** 系统显示当前用户作为处理人的待响应和处理中状态的任务列表（最多显示10条）

#### Scenario: 快速跳转任务详情
- **WHEN** 用户点击待办任务列表中的某个任务
- **THEN** 系统跳转到该任务的详情页面

### Requirement: 紧急任务提醒
系统SHALL突出显示即将到期或已逾期的紧急任务，提醒用户及时处理。

#### Scenario: 查看紧急任务
- **WHEN** 用户访问首页
- **THEN** 系统显示即将到期（24小时内）或已逾期的任务列表，按紧急程度排序

#### Scenario: 紧急任务视觉提醒
- **WHEN** 存在已逾期的任务
- **THEN** 系统使用红色标识显示，并在任务卡片上显示逾期天数

#### Scenario: 即将到期任务提醒
- **WHEN** 存在24小时内即将到期的任务
- **THEN** 系统使用橙色标识显示，并在任务卡片上显示剩余时间

### Requirement: 统计数据表
系统SHALL创建专用的统计数据表，用于存储预计算的任务统计结果。

#### Scenario: 统计表结构
- **WHEN** 系统初始化数据库
- **THEN** 创建 `task_statistics` 表，包含以下字段：
  - `id`: 主键，自增整数
  - `stat_type`: 统计类型（VARCHAR(50)），如 'overview', 'status_distribution', 'category_distribution'
  - `stat_key`: 统计键（VARCHAR(50)），如状态名称、分类名称，对于overview类型可为空
  - `stat_value`: 统计值（TEXT/JSON），存储统计数据的JSON格式
  - `updated_at`: 更新时间（DATETIME）
  - 唯一索引：`(stat_type, stat_key)`

#### Scenario: 统计数据查询性能
- **WHEN** 查询统计表
- **THEN** 响应时间MUST小于100ms

### Requirement: 定时统计任务
系统SHALL实现后台定时任务，定期统计任务数据并更新统计表。

#### Scenario: 定时任务调度
- **WHEN** 系统启动
- **THEN** 注册定时统计任务，每5分钟执行一次全量统计

#### Scenario: 全量统计执行
- **WHEN** 定时任务触发
- **THEN** 系统执行以下统计操作：
  - 统计总任务数
  - 统计各状态任务数（新建、待响应、处理中、挂起、已完成、关闭）
  - 统计各分类任务数（版本任务、紧急任务、普通任务、定时周期任务、其他任务）
  - 使用数据库事务更新统计表

#### Scenario: 统计任务失败处理
- **WHEN** 定时统计任务执行失败
- **THEN** 系统记录错误日志，不影响主业务流程，等待下次调度重试

### Requirement: 增量统计更新
系统SHALL在任务状态变更时，立即更新统计表，确保统计数据的准确性。

#### Scenario: 任务创建时更新统计
- **WHEN** 新任务被创建
- **THEN** 系统在同一事务中更新统计表（总任务数+1，对应状态和分类的计数+1）

#### Scenario: 任务状态变更时更新统计
- **WHEN** 任务状态发生变更
- **THEN** 系统在同一事务中更新统计表（旧状态计数-1，新状态计数+1）

#### Scenario: 任务删除时更新统计
- **WHEN** 任务被删除
- **THEN** 系统在同一事务中更新统计表（总任务数-1，对应状态和分类的计数-1）

#### Scenario: 统计更新事务一致性
- **WHEN** 任务表和统计表更新
- **THEN** 系统MUST使用数据库事务确保两者的一致性，任一失败则全部回滚

### Requirement: 统计数据API
系统SHALL提供后端API接口，从统计表中查询并返回首页驾驶舱所需的统计数据。

#### Scenario: 获取任务统计数据
- **WHEN** 前端请求 `GET /api/tasks/statistics`
- **THEN** 系统从统计表查询并返回包含以下数据的JSON响应：
  - 总任务数
  - 各状态任务数（新建、待响应、处理中、挂起、已完成、关闭）
  - 各分类任务数（版本任务、紧急任务、普通任务、定时周期任务、其他任务）
  - 统计数据更新时间

#### Scenario: 获取我的待办任务
- **WHEN** 前端请求 `GET /api/tasks/my-pending`
- **THEN** 系统实时查询任务表，返回当前用户作为处理人的待响应和处理中任务列表（最多10条，按创建时间倒序）

#### Scenario: 获取紧急任务列表
- **WHEN** 前端请求 `GET /api/tasks/urgent`
- **THEN** 系统实时查询任务表，返回即将到期（24小时内）或已逾期的任务列表，按紧急程度排序（已逾期优先，然后按剩余时间升序）

#### Scenario: API权限控制
- **WHEN** 未登录用户请求统计API
- **THEN** 系统返回401未授权错误

#### Scenario: API性能要求
- **WHEN** 统计API被调用
- **THEN** 系统MUST在100ms内返回响应（从统计表查询）
