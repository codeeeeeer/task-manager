# Design: 首页任务概览驾驶舱

## Context
当前首页仅显示欢迎信息，缺乏任务概览能力。需要添加驾驶舱功能，展示任务统计数据、状态分布、待办任务等信息。

关键约束：
- 项目已使用APScheduler进行定时任务调度
- 数据库为SQLite（开发）/ PostgreSQL（生产）
- 需要支持实时更新（通过WebSocket）

## Goals / Non-Goals

### Goals
- 提供快速的统计数据查询（<100ms响应时间）
- 支持高并发访问（多用户同时查看首页）
- 统计数据准确性在可接受范围内（允许短暂延迟）
- 最小化对现有任务表查询的性能影响

### Non-Goals
- 不需要毫秒级的实时统计（分钟级延迟可接受）
- 不需要支持自定义统计维度（固定统计项）
- 不需要历史统计数据趋势分析（仅当前状态）

## Decisions

### Decision 1: 使用定时统计+缓存表架构

**选择方案**: 后台定时任务统计 + 专用统计表存储

**理由**:
1. **性能优势**: 避免每次请求都执行复杂的聚合查询，查询统计表只需简单的主键查询
2. **可扩展性**: 当任务数量增长到数万、数十万时，实时聚合查询会成为瓶颈
3. **数据库负载**: 减少对任务表的频繁GROUP BY查询，降低数据库CPU和I/O压力
4. **响应时间**: 统计表查询可以在<100ms内完成，而实时聚合可能需要数秒

**替代方案考虑**:
- **方案A: 实时查询** - 简单直接，但在数据量大时性能差，不可扩展
- **方案B: Redis缓存** - 需要引入新依赖，增加系统复杂度，且缓存失效策略复杂
- **方案C: 物化视图** - PostgreSQL支持，但SQLite不支持，且刷新策略不够灵活

### Decision 2: 统计数据表设计

**表结构**: `task_statistics`
- `id`: 主键
- `stat_type`: 统计类型（'overview', 'status_distribution', 'category_distribution'）
- `stat_key`: 统计键（如状态名称、分类名称）
- `stat_value`: 统计值（JSON格式，存储数量等信息）
- `updated_at`: 更新时间

**理由**:
- 使用单表存储多种统计类型，简化表结构
- JSON字段提供灵活性，可以存储复杂的统计数据
- stat_type + stat_key 组合索引，确保快速查询

### Decision 3: 定时任务调度策略

**刷新频率**: 每5分钟执行一次统计任务

**理由**:
- 5分钟的延迟对于驾驶舱场景是可接受的
- 避免过于频繁的统计导致数据库负载过高
- 与现有APScheduler集成，无需额外依赖

**任务执行逻辑**:
1. 统计总任务数、各状态任务数、各分类任务数
2. 使用事务更新统计表，确保数据一致性
3. 失败时记录日志，不影响主业务流程

### Decision 4: 用户个性化数据实时查询

**选择方案**: 我的待办任务和紧急任务仍使用实时查询

**理由**:
1. 这些数据是用户个性化的，无法预先统计
2. 查询条件���单（按current_handler_id和状态筛选），有索引支持
3. 结果集较小（限制10条），查询性能可接受
4. 用户期望看到最新的待办任务，不能有延迟

### Decision 5: WebSocket实时更新策略

**选择方案**: 任务变更时触发统计表更新 + WebSocket推送

**理由**:
- 当任务状态变更时，立即更新统计表（增量更新）
- 通过WebSocket推送统计数据变更事件
- 前端收到推送后重新获取统计数据
- 结合定时全量统计，确保数据最终一致性

**实现细节**:
- 在任务创建、更新、删除时，同步更新统计表
- 使用数据库事务确保任务表和统计表的一致性
- 定时任务作为兜底机制，修正可能的数据不一致

## Risks / Trade-offs

### Risk 1: 统计数据延迟
- **风险**: 用户可能看到略微过时的统计数据（最多5分钟延迟）
- **缓解**: 通过WebSocket增量更新机制，大部分情况下延迟<1秒
- **接受度**: 驾驶舱场景对实时性要求不高，可接受

### Risk 2: 数据一致性
- **风险**: 任务表和统计表可能出现短暂不一致
- **缓解**: 使用数据库事务 + 定时全量统计兜底
- **接受度**: 最终一致性模型，可接受

### Risk 3: 统计表维护成本
- **风险**: 增加了数据库表和定时任务，增加系统复杂度
- **缓解**: 统计逻辑封装在service层，易于维护和测试
- **接受度**: 性能收益远大于维护成本

## Migration Plan

### 阶段1: 数据库迁移
1. 创建 `task_statistics` 表
2. 创建索引：`(stat_type, stat_key)`
3. 执行初始统计数据填充

### 阶段2: 后端实现
1. 实现统计服务方法
2. 实现定时任务
3. 在任务变更时触发增量更新
4. 实现统计数据API接口

### 阶段3: 前端集成
1. 调用统计API获取数据
2. 监听WebSocket统计更新事件
3. 实现驾驶舱UI组件

### 回滚方案
- 如果统计表方案出现问题，可以快速切换回实时查询
- 保留实时查询的代码路径作为降级方案
- 通过配置开关控制使用哪种查询方式

## Open Questions
- 是否需要支持按用户维度的统计缓存？（当前方案是全局统计）
- 统计表是否需要保留历史快照用于趋势分析？（当前方案仅保留最新数据）
