# 任务分发工具 - 整体架构设计

## 1. 系统概述

本系统是一个轻量级的任务分发与追踪工具，面向100人以下的团队，采用B/S架构 + 客户端通知的混合模式，支持内网部署。

## 2. 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         客户端层                                  │
├───────────────────────┬─────────────────────────────────────────┤
│  Web管理控制台         │        客户端通知程序                     │
│  (Vue.js SPA)         │  ┌──────────────┬──────────────┐         │
│                       │  │ Chrome插件    │  EXE程序      │         │
│                       │  │ (JS/HTML/CSS) │  (C++/MFC)   │         │
│                       │  └──────────────┴──────────────┘         │
└───────────────────────┴─────────────────────────────────────────┘
                                    ↓↑ HTTP/WebSocket
┌─────────────────────────────────────────────────────────────────┐
│                         应用服务层                                │
├─────────────────────────────────────────────────────────────────┤
│                      Flask Web Server                           │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  RESTful API 接口层                                        │  │
│  │  - JWT身份认证中间件                                       │  │
│  │  - CORS跨域处理                                           │  │
│  │  - 请求日志记录                                            │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌──────────┬──────────┬──────────┬──────────┬──────────────┐  │
│  │用户管理   │任务管理   │流转记录   │留言模块   │通知模块      │  │
│  │模块      │模块      │模块      │         │             │  │
│  └──────────┴──────────┴──────────┴──────────┴──────────────┘  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  WebSocket 推送层 (Flask-SocketIO)                        │  │
│  │  - 实时任务通知                                            │  │
│  │  - 预警消息推送                                            │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  定时任务调度器 (APScheduler)                              │  │
│  │  - 周期任务重置                                            │  │
│  │  - 预警检测任务                                            │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                    ↓↑ SQLAlchemy ORM
┌─────────────────────────────────────────────────────────────────┐
│                         数据持久层                                │
├─────────────────────────────────────────────────────────────────┤
│                      PostgreSQL 数据库                          │
│  ┌──────────┬──────────┬────────────────┬──────────────────┐   │
│  │ users    │ tasks    │ task_transfers │ task_comments    │   │
│  │ (用户表)  │ (任务表)  │ (流转记录表)    │ (留言表)          │   │
│  └──────────┴──────────┴────────────────┴──────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  文件存储 (本地文件系统 或 PostgreSQL LOB)                  │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 3. 核心模块交互流程

### 3.1 用户登录流程
```
Web控制台 → POST /api/auth/login → 用户管理模块
                                   ↓ 验证密码
                                   ↓ 生成JWT Token
                                   ← 返回Token + 用户信息
Web控制台 ← 存储Token到localStorage
```

### 3.2 创建任务流程
```
Web控制台 → POST /api/tasks (Header: Authorization)
            ↓
         JWT中间件验证身份
            ↓
         任务管理模块
            ├→ 验证权限
            ├→ 保存任务到数据库
            ├→ 创建初始流转记录
            └→ 触发通知模块
               ├→ WebSocket推送给当前处理人
               └→ 客户端程序接收通知
```

### 3.3 任务流转流程
```
Web控制台 → POST /api/tasks/{id}/transfer
            ↓
         任务管理模块
            ├→ 验证当前用户是否为任务处理人/管理员
            ├→ 更新任务的current_handler_id
            ├→ 更新任务状态为"待响应"
            ├→ 调用流转记录模块保存流转记录
            └→ 触发通知模块
               └→ 推送通知给新的处理人
```

### 3.4 任务留言流程
```
Web控制台 → POST /api/tasks/{id}/comments
            ↓
         留言模块
            ├→ 验证用户身份
            ├→ 保存留言到数据库
            └→ 触发通知模块
               └→ 推送通知给任务相关人员
```

### 3.5 定时任务预警流程
```
APScheduler (每小时执行一次)
    ↓
定时任务模块
    ├→ 查询所有"处理中"状态的任务
    ├→ 计算时间进度 = (当前时间 - 期望开始时间) / (期望完成时间 - 期望开始时间)
    ├→ 如果时间进度 > 80% 且处理进度 < 80% → 触发20%预警
    ├→ 如果时间进度 > 90% 且处理进度 < 90% → 触发10%预警
    ├→ 如果时间进度 > 95% 且处理进度 < 95% → 触发5%预警
    └→ 调用通知模块发送预警
       └→ WebSocket推送 + 邮件通知(可选)
```

### 3.6 周期任务重置流程
```
APScheduler (每天凌晨执行)
    ↓
定时任务模块
    ├→ 查询所有"定时周期任务"类型
    ├→ 检查是否到达周期时间点
    ├→ 重置任务状态为"新建"
    ├→ 清空处理进度
    └→ 调用通知模块发送提醒
```

### 3.7 客户端通知流程
```
客户端程序启动
    ↓
建立WebSocket连接 → ws://server:port/socket.io
    ↓
服务端验证用户UM编号
    ↓
加入用户专属Room
    ↓
接收通知消息
    ├→ 解析消息类型(新任务/流转/留言/预警)
    ├→ 播放提示音
    ├→ 显示系统通知弹窗
    └→ 点击弹窗 → 打开浏览器到任务详情页
```

## 4. 数据流向

### 4.1 读操作数据流
```
客户端请求 → Flask路由 → 业务模块 → SQLAlchemy → PostgreSQL
                                                    ↓
客户端响应 ← JSON序列化 ← 业务逻辑处理 ← ORM对象 ← 查询结果
```

### 4.2 写操作数据流
```
客户端请求 → Flask路由 → 数据验证 → 业务模块 → SQLAlchemy → PostgreSQL
                                       ↓
                                   触发通知
                                       ↓
                                WebSocket推送 → 客户端程序
```

## 5. 技术栈详细说明

### 5.1 后端 (Flask)
- **Flask 2.3+**: Web框架核心
- **Flask-RESTful**: 构建RESTful API
- **Flask-SocketIO**: WebSocket支持
- **Flask-JWT-Extended**: JWT认证
- **SQLAlchemy 2.0+**: ORM框架
- **Psycopg2**: PostgreSQL驱动
- **APScheduler**: 定时任务调度
- **Pandas**: Excel/CSV处理
- **Werkzeug**: 密码哈希、文件上传

### 5.2 前端 (Vue.js)
- **Vue 3.3+**: 前端框架
- **Vue Router**: 路由管理
- **Pinia**: 状态管理
- **Element Plus**: UI组件库(暖色调主题)
- **Axios**: HTTP客户端
- **Socket.IO Client**: WebSocket客户端
- **Vite**: 构建工具

### 5.3 客户端
**Chrome插件:**
- Manifest V3
- Background Service Worker
- Chrome Notifications API
- WebSocket (原生或Socket.IO)

**EXE程序:**
- C++ 17
- MFC (静态链接)
- WebSocket++ / IXWebSocket (轻量级)
- Windows API (通知、系统托盘)

### 5.4 数据库
- **PostgreSQL 12+**
- 字符集: UTF-8
- 时区设置: Asia/Shanghai

## 6. 部署架构

### 6.1 单机部署(推荐小团队)
```
[同一台服务器]
├─ PostgreSQL (端口5432)
├─ Flask应用 (端口5000)
│  ├─ HTTP API服务
│  ├─ WebSocket服务
│  └─ 定时任务调度
└─ 静态文件服务 (Nginx可选, 端口80)
```

### 6.2 访问方式
- Web控制台: `http://服务器IP:5000` 或 `http://服务器IP` (Nginx代理)
- WebSocket: `ws://服务器IP:5000/socket.io`
- 客户端配置: 填写服务器IP和端口

## 7. 安全设计

### 7.1 身份认证
- 使用JWT进行无状态认证
- Token有效期: 24小时
- Refresh Token机制(可选)

### 7.2 权限控制
- 管理员: 所有权限
- 普通用户: 只能操作自己作为处理人的任务
- 任务创建者: 查看权限，无操作权限

### 7.3 数据安全
- 密码使用bcrypt加密存储
- SQL注入防护: 使用ORM参数化查询
- XSS防护: 前端输入过滤，后端输出转义
- CSRF防护: JWT Token验证

## 8. 性能优化策略

### 8.1 数据库优化
- 为常用查询字段添加索引(创建时间、当前处理人、状态等)
- 任务列表分页查询，每页20-50条

### 8.2 缓存策略(可选)
- 用户信息缓存(Redis/内存缓存)
- 任务列表查询结果缓存

### 8.3 WebSocket优化
- 连接池管理
- 心跳机制(30秒一次)
- 自动重连(客户端)

## 9. 扩展性考虑

### 9.1 水平扩展(未来)
- Flask应用无状态，可部署多实例
- WebSocket需要Redis作为消息代理
- 负载均衡使用Nginx

### 9.2 功能扩展点
- 任务附件上传
- 邮件通知集成
- 移动端H5适配
- 数据统计报表

## 10. 开发规范

### 10.1 目录结构
```
taskManager/
├── backend/              # 后端代码
│   ├── app/
│   │   ├── models/      # 数据模型
│   │   ├── services/    # 业务逻辑
│   │   ├── api/         # API路由
│   │   ├── utils/       # 工具函数
│   │   └── __init__.py
│   ├── config.py        # 配置文件
│   ├── requirements.txt
│   └── run.py
├── frontend/            # 前端代码
│   ├── src/
│   │   ├── views/       # 页面组件
│   │   ├── components/  # 通用组件
│   │   ├── api/         # API封装
│   │   ├── store/       # 状态管理
│   │   └── router/      # 路由配置
│   ├── package.json
│   └── vite.config.js
├── client/              # 客户端代码
│   ├── chrome-extension/
│   └── exe-client/
├── docs/                # 文档
└── 任务分发工具.md       # 需求文档
```

### 10.2 接口规范
- RESTful API设计原则
- 统一响应格式: `{code: 0, message: "success", data: {...}}`
- 错误码定义: 0-成功, 4xx-客户端错误, 5xx-服务端错误

### 10.3 代码规范
- Python: PEP 8
- JavaScript: ESLint + Prettier
- Git提交规范: 约定式提交(Conventional Commits)
