# 前端架构设计文档

## 1. 技术栈

### 1.1 核心框架
- **Vue 3.3+**: 采用Composition API
- **Vue Router 4**: 前端路由
- **Pinia**: 状态管理
- **Vite 4**: 构建工具

### 1.2 UI组件库
- **Element Plus**: 主UI组件库
- **自定义暖色调主题**: 覆盖Element Plus默认主题

### 1.3 工具库
- **Axios**: HTTP请求
- **Socket.IO Client**: WebSocket连接
- **Day.js**: 日期处理
- **VueUse**: Vue组合式工具集

### 1.4 编辑器
- **Quill / TinyMCE**: 富文本编辑器(用于任务描述、留言)

### 1.5 其他
- **ECharts**(可选): 数据统计图表
- **XLSX**: Excel导入导出

## 2. 项目结构

```
frontend/
├── public/                    # 静态资源
│   ├── favicon.ico
│   └── notification.mp3       # 通知提示音
├── src/
│   ├── api/                   # API封装
│   │   ├── auth.js           # 认证相关
│   │   ├── user.js           # 用户管理
│   │   ├── task.js           # 任务管理
│   │   ├── comment.js        # 留言
│   │   └── request.js        # Axios实例
│   ├── assets/               # 资源文件
│   │   ├── styles/           # 样式
│   │   │   ├── variables.scss # 主题变量
│   │   │   ├── common.scss    # 通用样式
│   │   │   └── element-override.scss # Element Plus覆盖
│   │   └── images/           # 图片
│   ├── components/           # 通用组件
│   │   ├── Layout/           # 布局组件
│   │   │   ├── Header.vue
│   │   │   ├── Sidebar.vue
│   │   │   └── Footer.vue
│   │   ├── TaskCard.vue      # 任务卡片
│   │   ├── TaskTimeline.vue  # 流转时间轴
│   │   ├── RichEditor.vue    # 富文本编辑器封装
│   │   └── UserAvatar.vue    # 用户头像
│   ├── views/                # 页面组件
│   │   ├── Login.vue         # 登录页
│   │   ├── Home.vue          # 首页(任务概览)
│   │   ├── TaskList.vue      # 任务列表
│   │   ├── TaskDetail.vue    # 任务详情
│   │   ├── UserManage.vue    # 用户管理(管理员)
│   │   └── Profile.vue       # 个人中心
│   ├── router/               # 路由配置
│   │   └── index.js
│   ├── store/                # Pinia状态管理
│   │   ├── index.js
│   │   ├── auth.js           # 认证状态
│   │   ├── user.js           # 用户状态
│   │   ├── task.js           # 任务状态
│   │   └── notification.js   # 通知状态
│   ├── utils/                # 工具函数
│   │   ├── auth.js           # Token管理
│   │   ├── websocket.js      # WebSocket客户端
│   │   ├── constants.js      # 常量定义
│   │   └── helpers.js        # 辅助函数
│   ├── App.vue               # 根组件
│   └── main.js               # 入口文件
├── .env.development          # 开发环境配置
├── .env.production           # 生产环境配置
├── vite.config.js            # Vite配置
├── package.json
└── index.html
```

## 3. 核心模块设计

### 3.1 认证模块

#### 3.1.1 Token管理

```javascript
// src/utils/auth.js
const TOKEN_KEY = 'task_manager_token'

export function getToken() {
  return localStorage.getItem(TOKEN_KEY)
}

export function setToken(token) {
  localStorage.setItem(TOKEN_KEY, token)
}

export function removeToken() {
  localStorage.removeItem(TOKEN_KEY)
}

export function getUserInfo() {
  const userInfoStr = localStorage.getItem('user_info')
  return userInfoStr ? JSON.parse(userInfoStr) : null
}

export function setUserInfo(userInfo) {
  localStorage.setItem('user_info', JSON.stringify(userInfo))
}
```

#### 3.1.2 登录页面

```vue
<!-- src/views/Login.vue -->
<template>
  <div class="login-container">
    <el-card class="login-card">
      <h2>任务分发工具</h2>
      <el-form :model="loginForm" :rules="rules" ref="formRef">
        <el-form-item prop="email">
          <el-input
            v-model="loginForm.email"
            placeholder="邮箱"
            prefix-icon="Message"
          />
        </el-form-item>
        <el-form-item prop="password">
          <el-input
            v-model="loginForm.password"
            type="password"
            placeholder="密码"
            prefix-icon="Lock"
          />
        </el-form-item>
        <el-button
          type="primary"
          @click="handleLogin"
          :loading="loading"
          class="login-button"
        >
          登录
        </el-button>
      </el-form>
    </el-card>
  </div>
</template>

<script setup>
import { ref } from 'vue'
import { useRouter } from 'vue-router'
import { useAuthStore } from '@/store/auth'
import { ElMessage } from 'element-plus'

const router = useRouter()
const authStore = useAuthStore()

const loginForm = ref({
  email: '',
  password: ''
})

const rules = {
  email: [{ required: true, message: '请输入邮箱', trigger: 'blur' }],
  password: [{ required: true, message: '请输入密码', trigger: 'blur' }]
}

const loading = ref(false)
const formRef = ref(null)

const handleLogin = async () => {
  await formRef.value.validate()
  loading.value = true

  try {
    await authStore.login(loginForm.value)
    ElMessage.success('登录成功')
    router.push('/')
  } catch (error) {
    ElMessage.error(error.message || '登录失败')
  } finally {
    loading.value = false
  }
}
</script>

<style scoped lang="scss">
.login-container {
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);

  .login-card {
    width: 400px;
    padding: 20px;

    h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #ff6b6b;
    }

    .login-button {
      width: 100%;
    }
  }
}
</style>
```

### 3.2 API请求封装

#### 3.2.1 Axios实例

```javascript
// src/api/request.js
import axios from 'axios'
import { ElMessage } from 'element-plus'
import { getToken, removeToken } from '@/utils/auth'
import router from '@/router'

const request = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || 'http://localhost:5000',
  timeout: 10000
})

// 请求拦截器
request.interceptors.request.use(
  config => {
    const token = getToken()
    if (token) {
      config.headers.Authorization = `Bearer ${token}`
    }
    return config
  },
  error => {
    return Promise.reject(error)
  }
)

// 响应拦截器
request.interceptors.response.use(
  response => {
    const res = response.data

    // 统一响应格式处理
    if (res.code === 0) {
      return res.data
    } else {
      ElMessage.error(res.message || '请求失败')
      return Promise.reject(new Error(res.message || '请求失败'))
    }
  },
  error => {
    if (error.response) {
      switch (error.response.status) {
        case 401:
          ElMessage.error('未登录或登录已过期')
          removeToken()
          router.push('/login')
          break
        case 403:
          ElMessage.error('没有权限')
          break
        case 404:
          ElMessage.error('请求的资源不存在')
          break
        case 500:
          ElMessage.error('服务器错误')
          break
        default:
          ElMessage.error(error.response.data.message || '请求失败')
      }
    } else {
      ElMessage.error('网络错误')
    }
    return Promise.reject(error)
  }
)

export default request
```

#### 3.2.2 API模块

```javascript
// src/api/task.js
import request from './request'

// 获取任务列表
export function getTasks(params) {
  return request({
    url: '/api/tasks',
    method: 'get',
    params
  })
}

// 获取任务详情
export function getTaskDetail(taskId) {
  return request({
    url: `/api/tasks/${taskId}`,
    method: 'get'
  })
}

// 创建任务
export function createTask(data) {
  return request({
    url: '/api/tasks',
    method: 'post',
    data
  })
}

// 更新任务
export function updateTask(taskId, data) {
  return request({
    url: `/api/tasks/${taskId}`,
    method: 'put',
    data
  })
}

// 流转任务
export function transferTask(taskId, data) {
  return request({
    url: `/api/tasks/${taskId}/transfer`,
    method: 'post',
    data
  })
}

// 响应任务
export function respondTask(taskId) {
  return request({
    url: `/api/tasks/${taskId}/respond`,
    method: 'post'
  })
}

// 挂起任务
export function suspendTask(taskId, data) {
  return request({
    url: `/api/tasks/${taskId}/suspend`,
    method: 'post',
    data
  })
}

// 完成任务
export function completeTask(taskId, data) {
  return request({
    url: `/api/tasks/${taskId}/complete`,
    method: 'post',
    data
  })
}

// 获取流转记录
export function getTaskTransfers(taskId) {
  return request({
    url: `/api/tasks/${taskId}/transfers`,
    method: 'get'
  })
}

// 获取留言
export function getTaskComments(taskId) {
  return request({
    url: `/api/tasks/${taskId}/comments`,
    method: 'get'
  })
}

// 创建留言
export function createComment(taskId, data) {
  return request({
    url: `/api/tasks/${taskId}/comments`,
    method: 'post',
    data
  })
}

// 导出任务
export function exportTasks(params) {
  return request({
    url: '/api/tasks/export',
    method: 'get',
    params,
    responseType: 'blob'
  })
}
```

### 3.3 状态管理

#### 3.3.1 认证Store

```javascript
// src/store/auth.js
import { defineStore } from 'pinia'
import { login as loginApi } from '@/api/auth'
import { setToken, setUserInfo, getToken, getUserInfo, removeToken } from '@/utils/auth'

export const useAuthStore = defineStore('auth', {
  state: () => ({
    token: getToken(),
    userInfo: getUserInfo()
  }),

  getters: {
    isLoggedIn: (state) => !!state.token,
    isAdmin: (state) => state.userInfo?.is_admin || false,
    currentUserId: (state) => state.userInfo?.id || null
  },

  actions: {
    async login(credentials) {
      const res = await loginApi(credentials)
      this.token = res.token
      this.userInfo = res.user

      setToken(res.token)
      setUserInfo(res.user)
    },

    logout() {
      this.token = null
      this.userInfo = null
      removeToken()
    }
  }
})
```

#### 3.3.2 任务Store

```javascript
// src/store/task.js
import { defineStore } from 'pinia'
import { getTasks, getTaskDetail } from '@/api/task'

export const useTaskStore = defineStore('task', {
  state: () => ({
    tasks: [],
    total: 0,
    currentTask: null,
    filters: {
      page: 1,
      per_page: 20,
      search: '',
      status: '',
      category: '',
      current_handler_id: null
    }
  }),

  actions: {
    async fetchTasks(filters) {
      this.filters = { ...this.filters, ...filters }
      const res = await getTasks(this.filters)
      this.tasks = res.tasks
      this.total = res.total
    },

    async fetchTaskDetail(taskId) {
      this.currentTask = await getTaskDetail(taskId)
    },

    clearCurrentTask() {
      this.currentTask = null
    }
  }
})
```

### 3.4 WebSocket集成

```javascript
// src/utils/websocket.js
import io from 'socket.io-client'
import { getToken } from './auth'
import { ElNotification } from 'element-plus'

class WebSocketClient {
  constructor() {
    this.socket = null
    this.connected = false
    this.reconnectAttempts = 0
    this.maxReconnectAttempts = 10
  }

  connect() {
    const serverUrl = import.meta.env.VITE_WS_URL || 'http://localhost:5000'
    const token = getToken()

    if (!token) {
      console.log('No token, skip WebSocket connection')
      return
    }

    this.socket = io(serverUrl, {
      auth: { token },
      transports: ['websocket'],
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionAttempts: this.maxReconnectAttempts
    })

    this.setupEventHandlers()
  }

  setupEventHandlers() {
    this.socket.on('connect', () => {
      console.log('WebSocket connected')
      this.connected = true
      this.reconnectAttempts = 0
    })

    this.socket.on('disconnect', () => {
      console.log('WebSocket disconnected')
      this.connected = false
    })

    this.socket.on('connected', (data) => {
      console.log('Server confirmed:', data)
    })

    this.socket.on('notification', (notification) => {
      this.handleNotification(notification)
    })

    this.socket.on('pong', (data) => {
      console.log('Pong:', data)
    })

    // 心跳
    setInterval(() => {
      if (this.connected) {
        this.socket.emit('ping')
      }
    }, 30000)
  }

  handleNotification(notification) {
    // 播放提示音
    this.playSound()

    // 显示通知
    const notificationTypes = {
      '新任务': 'info',
      '任务流转': 'info',
      '任务留言': 'info',
      '任务预警': 'warning',
      '任务完成': 'success'
    }

    ElNotification({
      title: notification.title,
      message: notification.content,
      type: notificationTypes[notification.type] || 'info',
      duration: 5000,
      onClick: () => {
        if (notification.task_id) {
          window.location.href = `/#/tasks/${notification.task_id}`
        }
      }
    })
  }

  playSound() {
    try {
      const audio = new Audio('/notification.mp3')
      audio.play().catch(e => console.log('Sound play failed:', e))
    } catch (e) {
      console.log('Sound play error:', e)
    }
  }

  disconnect() {
    if (this.socket) {
      this.socket.disconnect()
      this.socket = null
      this.connected = false
    }
  }
}

export default new WebSocketClient()
```

### 3.5 路由配置

```javascript
// src/router/index.js
import { createRouter, createWebHashHistory } from 'vue-router'
import { getToken } from '@/utils/auth'

const routes = [
  {
    path: '/login',
    name: 'Login',
    component: () => import('@/views/Login.vue'),
    meta: { requiresAuth: false }
  },
  {
    path: '/',
    component: () => import('@/components/Layout/MainLayout.vue'),
    meta: { requiresAuth: true },
    children: [
      {
        path: '',
        name: 'Home',
        component: () => import('@/views/Home.vue')
      },
      {
        path: 'tasks',
        name: 'TaskList',
        component: () => import('@/views/TaskList.vue')
      },
      {
        path: 'tasks/:id',
        name: 'TaskDetail',
        component: () => import('@/views/TaskDetail.vue')
      },
      {
        path: 'users',
        name: 'UserManage',
        component: () => import('@/views/UserManage.vue'),
        meta: { requiresAdmin: true }
      },
      {
        path: 'profile',
        name: 'Profile',
        component: () => import('@/views/Profile.vue')
      }
    ]
  }
]

const router = createRouter({
  history: createWebHashHistory(),
  routes
})

// 路由守卫
router.beforeEach((to, from, next) => {
  const token = getToken()

  if (to.meta.requiresAuth && !token) {
    next('/login')
  } else if (to.path === '/login' && token) {
    next('/')
  } else {
    next()
  }
})

export default router
```

## 4. 主题定制

### 4.1 暖色调配色方案

```scss
// src/assets/styles/variables.scss
$primary-color: #ff6b6b;      // 主色调-珊瑚红
$success-color: #51cf66;      // 成功色-清新绿
$warning-color: #ffa94d;      // 警告色-橙黄
$danger-color: #ff6b6b;       // 危险色-红
$info-color: #74c0fc;         // 信息色-天蓝

$background-color: #fff5f5;   // 背景色-浅粉
$text-primary: #495057;       // 主文字
$text-secondary: #868e96;     // 次要文字

$border-radius: 8px;
$box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
```

### 4.2 Element Plus主题覆盖

```scss
// src/assets/styles/element-override.scss
@forward 'element-plus/theme-chalk/src/common/var.scss' with (
  $colors: (
    'primary': (
      'base': #ff6b6b,
    ),
    'success': (
      'base': #51cf66,
    ),
    'warning': (
      'base': #ffa94d,
    ),
    'danger': (
      'base': #ff6b6b,
    ),
    'info': (
      'base': #74c0fc,
    )
  )
);
```

## 5. 关键页面设计

### 5.1 任务列表页

**功能:**
- 搜索筛选(标题、状态、分类、处理人、创建时间)
- 分页展示
- 快速操作(响应、查看详情)
- 导出功能

### 5.2 任务详情页

**布局:**
1. 顶部: 任务标题 + 状态标签
2. 操作按钮区: 响应、流转、挂起、完成、关闭
3. 基本信息卡片: 创建时间、创建人、分类、进度等
4. 任务描述卡片: 富文本显示
5. 流转时间轴
6. 留言区域: 列表 + 编辑器

### 5.3 用户管理页(管理员)

**功能:**
- 用户列表(搜索、分页)
- 创建用户
- 编辑用户
- 批量导入(Excel/CSV)
- 重置密码

## 6. 性能优化

### 6.1 懒加载
- 路由懒加载
- 图片懒加载
- 组件懒加载

### 6.2 缓存策略
- 任务列表数据缓存(Pinia)
- 用户信息缓存
- 静态资源浏览器缓存

### 6.3 打包优化
```javascript
// vite.config.js
export default {
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'element-plus': ['element-plus'],
          'vue-vendor': ['vue', 'vue-router', 'pinia'],
          'editor': ['quill']
        }
      }
    }
  }
}
```

## 7. 部署

### 7.1 构建
```bash
npm run build
```

### 7.2 Nginx配置
```nginx
server {
    listen 80;
    server_name localhost;

    root /var/www/taskmanager/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /socket.io {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```
