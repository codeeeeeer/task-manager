# 数据库设计文档

## 1. 数据库概述

- **数据库类型**: PostgreSQL 12+
- **字符集**: UTF-8
- **排序规则**: zh_CN.UTF-8
- **时区**: Asia/Shanghai

## 2. 表结构设计

### 2.1 用户表 (users)

存储系统所有用户信息，包括管理员和普通用户。

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    um_code VARCHAR(50) UNIQUE NOT NULL,          -- 用户UM编号
    name VARCHAR(100) NOT NULL,                   -- 用户姓名
    email VARCHAR(255) UNIQUE NOT NULL,           -- 邮箱
    password_hash VARCHAR(255) NOT NULL,          -- 密码哈希值
    is_admin BOOLEAN DEFAULT FALSE,               -- 是否管理员
    is_active BOOLEAN DEFAULT TRUE,               -- 是否激活
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP,                      -- 最后登录时间

    CONSTRAINT check_email_format CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
);

-- 索引
CREATE INDEX idx_users_um_code ON users(um_code);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_is_active ON users(is_active);

-- 注释
COMMENT ON TABLE users IS '用户表';
COMMENT ON COLUMN users.um_code IS '用户唯一编号';
COMMENT ON COLUMN users.password_hash IS '使用bcrypt加密的密码';
```

**字段说明:**
- `id`: 主键，自增
- `um_code`: 用户编号，唯一标识，用于客户端配置
- `name`: 用户姓名，用于界面显示
- `email`: 邮箱，登录凭证之一，唯一
- `password_hash`: 密码哈希，使用bcrypt加密存储
- `is_admin`: 管理员标识，默认false
- `is_active`: 账户是否激活，软删除使用
- `created_at`: 创建时间
- `updated_at`: 更新时间
- `last_login_at`: 最后登录时间，用于统计

### 2.2 任务表 (tasks)

存储所有任务的主体信息。

```sql
CREATE TABLE tasks (
    id SERIAL PRIMARY KEY,
    title VARCHAR(500) NOT NULL,                  -- 任务标题
    category VARCHAR(50) NOT NULL,                -- 任务分类
    description TEXT,                             -- 任务详情描述
    status VARCHAR(50) NOT NULL DEFAULT '新建',   -- 任务状态
    progress INTEGER DEFAULT 0,                   -- 处理进度(0-100)
    time_progress INTEGER DEFAULT 0,              -- 时间进度(0-100)

    creator_id INTEGER NOT NULL,                  -- 创建人ID
    current_handler_id INTEGER NOT NULL,          -- 当前处理人ID

    expected_start_time TIMESTAMP,                -- 期望开始时间
    expected_end_time TIMESTAMP,                  -- 期望完成时间
    actual_start_time TIMESTAMP,                  -- 实际开始时间
    actual_end_time TIMESTAMP,                    -- 实际完成时间

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- 外键约束
    CONSTRAINT fk_tasks_creator FOREIGN KEY (creator_id)
        REFERENCES users(id) ON DELETE RESTRICT,
    CONSTRAINT fk_tasks_handler FOREIGN KEY (current_handler_id)
        REFERENCES users(id) ON DELETE RESTRICT,

    -- 检查约束
    CONSTRAINT check_progress_range CHECK (progress >= 0 AND progress <= 100),
    CONSTRAINT check_time_progress_range CHECK (time_progress >= 0 AND time_progress <= 100),
    CONSTRAINT check_expected_time CHECK (expected_end_time > expected_start_time),
    CONSTRAINT check_category CHECK (category IN ('版本任务', '紧急任务', '其他任务', '定时周期任务'))
);

-- 索引
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_category ON tasks(category);
CREATE INDEX idx_tasks_creator ON tasks(creator_id);
CREATE INDEX idx_tasks_handler ON tasks(current_handler_id);
CREATE INDEX idx_tasks_created_at ON tasks(created_at DESC);
CREATE INDEX idx_tasks_expected_end ON tasks(expected_end_time);
CREATE INDEX idx_tasks_composite ON tasks(status, current_handler_id, expected_end_time);

-- 全文搜索索引(针对标题)
CREATE INDEX idx_tasks_title_gin ON tasks USING gin(to_tsvector('chinese', title));

-- 注释
COMMENT ON TABLE tasks IS '任务表';
COMMENT ON COLUMN tasks.category IS '任务分类: 版本任务/紧急任务/其他任务/定时周期任务';
COMMENT ON COLUMN tasks.status IS '任务状态: 新建/待响应/处理中/挂起/已完成/关闭';
COMMENT ON COLUMN tasks.progress IS '处理进度百分比(0-100)';
COMMENT ON COLUMN tasks.time_progress IS '时间进度百分比(0-100)，由后台计算';
```

**字段说明:**
- `id`: 主键
- `title`: 任务标题，最多500字符
- `category`: 任务分类，枚举值
- `description`: 任务详情，支持富文本(存储HTML或Markdown)
- `status`: 任务状态，枚举值(新建、待响应、处理中、挂起、已完成、关闭)
- `progress`: 处理进度，0-100的整数
- `time_progress`: 时间进度，由定时任务计算更新
- `creator_id`: 创建人，外键关联users
- `current_handler_id`: 当前处理人，外键关联users
- `expected_start_time`: 期望开始时间
- `expected_end_time`: 期望完成时间
- `actual_start_time`: 实际开始时间(用户响应任务时记录)
- `actual_end_time`: 实际完成时间

### 2.3 任务流转记录表 (task_transfers)

记录任务的所有流转历史。

```sql
CREATE TABLE task_transfers (
    id SERIAL PRIMARY KEY,
    task_id INTEGER NOT NULL,                     -- 任务ID
    operator_id INTEGER NOT NULL,                 -- 操作人ID
    target_user_id INTEGER NOT NULL,              -- 流转目标用户ID
    message TEXT,                                 -- 流转留言
    transfer_type VARCHAR(50) DEFAULT '流转',     -- 流转类型
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- 外键约束
    CONSTRAINT fk_transfers_task FOREIGN KEY (task_id)
        REFERENCES tasks(id) ON DELETE CASCADE,
    CONSTRAINT fk_transfers_operator FOREIGN KEY (operator_id)
        REFERENCES users(id) ON DELETE RESTRICT,
    CONSTRAINT fk_transfers_target FOREIGN KEY (target_user_id)
        REFERENCES users(id) ON DELETE RESTRICT,

    -- 检查约束
    CONSTRAINT check_transfer_type CHECK (transfer_type IN ('创建', '流转', '响应', '挂起', '恢复', '完成', '关闭'))
);

-- 索引
CREATE INDEX idx_transfers_task ON task_transfers(task_id);
CREATE INDEX idx_transfers_created_at ON task_transfers(created_at DESC);

-- 注释
COMMENT ON TABLE task_transfers IS '任务流转记录表';
COMMENT ON COLUMN task_transfers.transfer_type IS '流转类型: 创建/流转/响应/挂起/恢复/完成/关闭';
```

**字段说明:**
- `id`: 主键
- `task_id`: 关联的任务ID
- `operator_id`: 执行流转操作的用户
- `target_user_id`: 流转的目标用户
- `message`: 流转时的留言说明
- `transfer_type`: 流转类型，区分不同的操作(创建、流转、响应等)
- `created_at`: 流转时间

**设计说明:**
- 创建任务时自动创建一条"创建"类型的流转记录
- 每次任务流转、响应、挂起等操作都会产生一条记录
- 使用CASCADE删除，任务删除时同步删除流转记录

### 2.4 任务留言表 (task_comments)

记录任务的所有留言。

```sql
CREATE TABLE task_comments (
    id SERIAL PRIMARY KEY,
    task_id INTEGER NOT NULL,                     -- 任务ID
    user_id INTEGER NOT NULL,                     -- 留言人ID
    content TEXT NOT NULL,                        -- 留言内容
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT FALSE,             -- 软删除标记

    -- 外键约束
    CONSTRAINT fk_comments_task FOREIGN KEY (task_id)
        REFERENCES tasks(id) ON DELETE CASCADE,
    CONSTRAINT fk_comments_user FOREIGN KEY (user_id)
        REFERENCES users(id) ON DELETE RESTRICT
);

-- 索引
CREATE INDEX idx_comments_task ON task_comments(task_id, created_at DESC);
CREATE INDEX idx_comments_user ON task_comments(user_id);

-- 注释
COMMENT ON TABLE task_comments IS '任务留言表';
COMMENT ON COLUMN task_comments.content IS '留言内容，支持富文本和图片';
```

**字段说明:**
- `id`: 主键
- `task_id`: 关联的任务ID
- `user_id`: 留言用户ID
- `content`: 留言内容，支持富文本(HTML/Markdown)
- `created_at`: 留言时间
- `updated_at`: 更新时间(支持编辑留言)
- `is_deleted`: 软删除标记

### 2.5 文件附件表 (task_attachments) - 可选扩展

如果需要支持任务附件上传功能：

```sql
CREATE TABLE task_attachments (
    id SERIAL PRIMARY KEY,
    task_id INTEGER NOT NULL,                     -- 任务ID
    user_id INTEGER NOT NULL,                     -- 上传人ID
    file_name VARCHAR(255) NOT NULL,              -- 文件名
    file_path VARCHAR(500) NOT NULL,              -- 文件存储路径
    file_size INTEGER NOT NULL,                   -- 文件大小(字节)
    file_type VARCHAR(100),                       -- 文件MIME类型
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- 外键约束
    CONSTRAINT fk_attachments_task FOREIGN KEY (task_id)
        REFERENCES tasks(id) ON DELETE CASCADE,
    CONSTRAINT fk_attachments_user FOREIGN KEY (user_id)
        REFERENCES users(id) ON DELETE RESTRICT
);

CREATE INDEX idx_attachments_task ON task_attachments(task_id);
```

### 2.6 通知记录表 (notifications) - 可选扩展

记录发送给用户的通知历史：

```sql
CREATE TABLE notifications (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,                     -- 接收人ID
    task_id INTEGER,                              -- 关联任务ID(可选)
    notification_type VARCHAR(50) NOT NULL,       -- 通知类型
    title VARCHAR(255) NOT NULL,                  -- 通知标题
    content TEXT,                                 -- 通知内容
    is_read BOOLEAN DEFAULT FALSE,                -- 是否已读
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    read_at TIMESTAMP,                            -- 阅读时间

    CONSTRAINT fk_notifications_user FOREIGN KEY (user_id)
        REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_notifications_task FOREIGN KEY (task_id)
        REFERENCES tasks(id) ON DELETE CASCADE,
    CONSTRAINT check_notification_type CHECK (notification_type IN ('新任务', '任务流转', '任务留言', '任务预警', '任务完成'))
);

CREATE INDEX idx_notifications_user ON notifications(user_id, is_read, created_at DESC);
```

## 3. 数据字典

### 3.1 任务状态枚举
| 状态值 | 说明 | 可流转状态 |
|-------|------|-----------|
| 新建 | 任务刚创建 | 待响应 |
| 待响应 | 任务已流转，等待处理人响应 | 处理中 |
| 处理中 | 处理人已响应，正在处理 | 挂起、已完成、待响应(流转) |
| 挂起 | 任务暂时挂起 | 处理中(恢复) |
| 已完成 | 任务已完成 | 关闭 |
| 关闭 | 任务关闭归档 | - |

### 3.2 任务分类枚举
| 分类值 | 说明 |
|-------|------|
| 版本任务 | 按版本计划的开发任务 |
| 紧急任务 | 需要紧急处理的任务 |
| 其他任务 | 常规任务 |
| 定时周期任务 | 定期重复的任务(如周报、月报) |

### 3.3 流转类型枚举
| 类型值 | 说明 | 操作人 |
|-------|------|--------|
| 创建 | 创建任务 | 创建人 |
| 流转 | 流转给其他人 | 当前处理人/管理员 |
| 响应 | 响应任务 | 当前处理人 |
| 挂起 | 挂起任务 | 当前处理人/管理员 |
| 恢复 | 恢复挂起的任务 | 当前处理人/管理员 |
| 完成 | 完成任务 | 当前处理人/管理员 |
| 关闭 | 关闭任务 | 管理员 |

### 3.4 通知类型枚举
| 类型值 | 触发场景 |
|-------|---------|
| 新任务 | 任务创建时通知处理人 |
| 任务流转 | 任务流转给新处理人时 |
| 任务留言 | 任务有新留言时通知相关人员 |
| 任务预警 | 任务时间进度达到预警阈值 |
| 任务完成 | 任务完成时通知创建人 |

## 4. 初始化数据

### 4.1 默认管理员账户

```sql
-- 默认密码: admin123 (实际使用需要bcrypt加密)
INSERT INTO users (um_code, name, email, password_hash, is_admin, is_active)
VALUES (
    'UM001',
    '系统管理员',
    'admin@example.com',
    '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyYCkPeko8bS',  -- admin123
    TRUE,
    TRUE
);
```

## 5. 数据库触发器

### 5.1 自动更新updated_at字段

```sql
-- 创建触发器函数
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 应用到users表
CREATE TRIGGER trigger_users_updated_at
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();

-- 应用到tasks表
CREATE TRIGGER trigger_tasks_updated_at
BEFORE UPDATE ON tasks
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();

-- 应用到task_comments表
CREATE TRIGGER trigger_comments_updated_at
BEFORE UPDATE ON task_comments
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

### 5.2 任务创建时自动创建流转记录

```sql
CREATE OR REPLACE FUNCTION create_initial_transfer()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO task_transfers (task_id, operator_id, target_user_id, message, transfer_type)
    VALUES (NEW.id, NEW.creator_id, NEW.current_handler_id, '任务创建', '创建');
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_task_initial_transfer
AFTER INSERT ON tasks
FOR EACH ROW
EXECUTE FUNCTION create_initial_transfer();
```

## 6. 常用查询SQL

### 6.1 查询用户的待处理任务

```sql
SELECT t.id, t.title, t.status, t.expected_end_time, u.name AS creator_name
FROM tasks t
JOIN users u ON t.creator_id = u.id
WHERE t.current_handler_id = $1  -- 用户ID
  AND t.status IN ('待响应', '处理中')
ORDER BY t.expected_end_time ASC;
```

### 6.2 查询任务的完整流转历史

```sql
SELECT
    tt.id,
    tt.transfer_type,
    u_operator.name AS operator_name,
    u_target.name AS target_name,
    tt.message,
    tt.created_at
FROM task_transfers tt
JOIN users u_operator ON tt.operator_id = u_operator.id
JOIN users u_target ON tt.target_user_id = u_target.id
WHERE tt.task_id = $1
ORDER BY tt.created_at ASC;
```

### 6.3 查询需要预警的任务

```sql
SELECT
    t.id,
    t.title,
    t.current_handler_id,
    t.expected_start_time,
    t.expected_end_time,
    t.progress,
    EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - t.expected_start_time)) /
    EXTRACT(EPOCH FROM (t.expected_end_time - t.expected_start_time)) * 100 AS time_progress_calc
FROM tasks t
WHERE t.status = '处理中'
  AND t.expected_end_time IS NOT NULL
  AND t.expected_start_time IS NOT NULL
  AND (
      -- 时间进度80%，处理进度<80%
      (EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - t.expected_start_time)) /
       EXTRACT(EPOCH FROM (t.expected_end_time - t.expected_start_time)) >= 0.8
       AND t.progress < 80)
      OR
      -- 时间进度90%，处理进度<90%
      (EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - t.expected_start_time)) /
       EXTRACT(EPOCH FROM (t.expected_end_time - t.expected_start_time)) >= 0.9
       AND t.progress < 90)
      OR
      -- 时间进度95%，处理进度<95%
      (EXTRACT(EPOCH FROM (CURRENT_TIMESTAMP - t.expected_start_time)) /
       EXTRACT(EPOCH FROM (t.expected_end_time - t.expected_start_time)) >= 0.95
       AND t.progress < 95)
  );
```

## 7. 数据备份策略

### 7.1 定期备份
- 每天凌晨3点自动备份数据库
- 备份保留30天
- 使用pg_dump工具

### 7.2 备份命令示例

```bash
# 完整备份
pg_dump -h localhost -U postgres -d taskmanager -F c -f backup_$(date +%Y%m%d).dump

# 恢复备份
pg_restore -h localhost -U postgres -d taskmanager -c backup_20250101.dump
```

## 8. 性能优化建议

1. **定期执行VACUUM**: 清理死元组，优化查询性能
2. **分析统计信息**: 定期执行ANALYZE更新统计信息
3. **监控慢查询**: 启用pg_stat_statements扩展
4. **分区表**: 如果任务量超过10万，考虑按创建时间分区
5. **连接池**: 使用PgBouncer或SQLAlchemy的连接池

## 9. 数据迁移脚本

### 9.1 创建数据库

```sql
CREATE DATABASE taskmanager
    WITH
    OWNER = postgres
    ENCODING = 'UTF8'
    LC_COLLATE = 'zh_CN.UTF-8'
    LC_CTYPE = 'zh_CN.UTF-8'
    TABLESPACE = pg_default
    CONNECTION LIMIT = -1;
```

### 9.2 完整建表脚本

见上述各表的CREATE TABLE语句，按以下顺序执行：
1. users表
2. tasks表
3. task_transfers表
4. task_comments表
5. 创建触发器
6. 插入默认管理员数据
