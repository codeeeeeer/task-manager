# 留言模块设计文档

## 1. 模块概述

留言模块负责任务的评论和留言功能，支持富文本内容和图片。所有用户都可以对任务进行留言。

## 2. 核心功能

- 创建留言
- 查询任务留言列表
- 编辑留言
- 删除留言(软删除)
- 留言通知

## 3. 数据模型

### 3.1 TaskComment模型

```python
from sqlalchemy import Column, Integer, Text, DateTime, ForeignKey, Boolean
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from app.models.base import Base

class TaskComment(Base):
    __tablename__ = 'task_comments'

    id = Column(Integer, primary_key=True, autoincrement=True)
    task_id = Column(Integer, ForeignKey('tasks.id', ondelete='CASCADE'), nullable=False, index=True)
    user_id = Column(Integer, ForeignKey('users.id'), nullable=False)
    content = Column(Text, nullable=False)
    created_at = Column(DateTime, default=func.now())
    updated_at = Column(DateTime, default=func.now(), onupdate=func.now())
    is_deleted = Column(Boolean, default=False)

    # 关系
    task = relationship('Task', back_populates='comments')
    user = relationship('User')

    def to_dict(self):
        """转换为字典"""
        return {
            'id': self.id,
            'task_id': self.task_id,
            'user_id': self.user_id,
            'user_name': self.user.name if self.user else None,
            'content': self.content,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None,
            'is_deleted': self.is_deleted
        }
```

## 4. 业务逻辑层

### 4.1 CommentService类

```python
from app.models.task_comment import TaskComment
from app.models.task import Task
from app.utils.database import db_session

class CommentService:
    """留言业务逻辑服务"""

    @staticmethod
    def create_comment(task_id, user_id, content):
        """
        创建留言
        :param task_id: 任务ID
        :param user_id: 用户ID
        :param content: 留言内容
        :return: TaskComment对象
        """
        # 验证任务存在
        task = db_session.query(Task).filter_by(id=task_id).first()
        if not task:
            raise ValueError("任务不存在")

        if not content or not content.strip():
            raise ValueError("留言内容不能为空")

        comment = TaskComment(
            task_id=task_id,
            user_id=user_id,
            content=content
        )

        db_session.add(comment)
        db_session.commit()

        return comment

    @staticmethod
    def get_comment_by_id(comment_id):
        """获取留言详情"""
        return db_session.query(TaskComment)\
            .filter_by(id=comment_id, is_deleted=False)\
            .first()

    @staticmethod
    def get_task_comments(task_id, include_deleted=False):
        """
        获取任务的所有留言
        :param task_id: 任务ID
        :param include_deleted: 是否包含已删除的留言
        :return: TaskComment列表
        """
        query = db_session.query(TaskComment).filter_by(task_id=task_id)

        if not include_deleted:
            query = query.filter_by(is_deleted=False)

        comments = query.order_by(TaskComment.created_at.asc()).all()

        return [comment.to_dict() for comment in comments]

    @staticmethod
    def update_comment(comment_id, user_id, content):
        """
        更新留言
        :param comment_id: 留言ID
        :param user_id: 用户ID(验证权限)
        :param content: 新内容
        :return: TaskComment对象
        """
        comment = CommentService.get_comment_by_id(comment_id)
        if not comment:
            raise ValueError("留言不存在")

        # 只有留言创建者可以编辑
        if comment.user_id != user_id:
            raise PermissionError("只能编辑自己的留言")

        if not content or not content.strip():
            raise ValueError("留言内容不能为空")

        comment.content = content
        db_session.commit()

        return comment

    @staticmethod
    def delete_comment(comment_id, user_id, is_admin=False):
        """
        删除留言(软删除)
        :param comment_id: 留言ID
        :param user_id: 用户ID
        :param is_admin: 是否管理员
        :return: True
        """
        comment = CommentService.get_comment_by_id(comment_id)
        if not comment:
            raise ValueError("留言不存在")

        # 只有留言创建者或管理员可以删除
        if comment.user_id != user_id and not is_admin:
            raise PermissionError("没有权限删除此留言")

        comment.is_deleted = True
        db_session.commit()

        return True

    @staticmethod
    def get_comment_count(task_id):
        """
        获取任务留言数量
        :param task_id: 任务ID
        :return: 留言数量
        """
        return db_session.query(TaskComment)\
            .filter_by(task_id=task_id, is_deleted=False)\
            .count()

    @staticmethod
    def get_user_comments(user_id, limit=50):
        """
        获取用户的留言历史
        :param user_id: 用户ID
        :param limit: 返回数量
        :return: TaskComment列表
        """
        comments = db_session.query(TaskComment)\
            .filter_by(user_id=user_id, is_deleted=False)\
            .order_by(TaskComment.created_at.desc())\
            .limit(limit)\
            .all()

        return [comment.to_dict() for comment in comments]
```

## 5. API接口层

### 5.1 RESTful API定义

#### 5.1.1 创建留言
```
POST /api/tasks/{task_id}/comments
Authorization: Bearer <token>
Content-Type: application/json

Request:
{
    "content": "这个功能需要注意安全性问题"
}

Response:
{
    "code": 0,
    "message": "留言成功",
    "data": {
        "id": 1,
        "task_id": 1,
        "user_id": 2,
        "user_name": "李四",
        "content": "这个功能需要注意安全性问题",
        "created_at": "2025-01-15T15:30:00"
    }
}
```

#### 5.1.2 获取任务留言列表
```
GET /api/tasks/{task_id}/comments
Authorization: Bearer <token>

Response:
{
    "code": 0,
    "message": "success",
    "data": [
        {
            "id": 1,
            "task_id": 1,
            "user_id": 2,
            "user_name": "李四",
            "content": "这个功能需要注意安全性问题",
            "created_at": "2025-01-15T15:30:00",
            "updated_at": "2025-01-15T15:30:00"
        },
        {
            "id": 2,
            "task_id": 1,
            "user_id": 1,
            "user_name": "张三",
            "content": "已经考虑到了，使用了JWT认证",
            "created_at": "2025-01-15T16:00:00",
            "updated_at": "2025-01-15T16:00:00"
        }
    ]
}
```

#### 5.1.3 更新留言
```
PUT /api/comments/{comment_id}
Authorization: Bearer <token>
Content-Type: application/json

Request:
{
    "content": "修改后的留言内容"
}

Response:
{
    "code": 0,
    "message": "留言更新成功",
    "data": {...}
}
```

#### 5.1.4 删除留言
```
DELETE /api/comments/{comment_id}
Authorization: Bearer <token>

Response:
{
    "code": 0,
    "message": "留言已删除",
    "data": null
}
```

## 6. 富文本支持

### 6.1 支持的格式
- HTML格式(推荐)
- Markdown格式
- 图片(Base64或URL)

### 6.2 前端编辑器建议
- TinyMCE
- Quill
- Vue-Quill-Editor

### 6.3 内容安全
```python
import bleach

def sanitize_html_content(content):
    """
    清理HTML内容，防止XSS
    """
    allowed_tags = ['p', 'br', 'strong', 'em', 'u', 'a', 'img', 'ul', 'ol', 'li', 'blockquote', 'code', 'pre']
    allowed_attrs = {
        'a': ['href', 'title'],
        'img': ['src', 'alt', 'title', 'width', 'height'],
    }

    return bleach.clean(content, tags=allowed_tags, attributes=allowed_attrs, strip=True)
```

## 7. 留言通知

### 7.1 通知规则
- 有新留言时，通知任务的当前处理人和创建人
- 如果留言@了某人，通知被@的人

### 7.2 通知示例
```python
from app.services.notification_service import NotificationService

def notify_new_comment(comment):
    """新留言通知"""
    task = comment.task

    # 通知当前处理人
    if task.current_handler_id != comment.user_id:
        NotificationService.send_notification(
            user_id=task.current_handler_id,
            task_id=task.id,
            notification_type='任务留言',
            title=f'任务「{task.title}」有新留言',
            content=f'{comment.user.name}: {comment.content[:50]}...'
        )

    # 通知创建人
    if task.creator_id != comment.user_id and task.creator_id != task.current_handler_id:
        NotificationService.send_notification(
            user_id=task.creator_id,
            task_id=task.id,
            notification_type='任务留言',
            title=f'任务「{task.title}」有新留言',
            content=f'{comment.user.name}: {comment.content[:50]}...'
        )
```

## 8. 前端展示建议

### 8.1 留言列表组件

```vue
<template>
  <div class="comment-list">
    <div v-for="comment in comments" :key="comment.id" class="comment-item">
      <div class="comment-header">
        <span class="user-name">{{ comment.user_name }}</span>
        <span class="comment-time">{{ formatTime(comment.created_at) }}</span>
      </div>
      <div class="comment-content" v-html="comment.content"></div>
      <div class="comment-actions">
        <a v-if="canEdit(comment)" @click="editComment(comment)">编辑</a>
        <a v-if="canDelete(comment)" @click="deleteComment(comment)">删除</a>
      </div>
    </div>
  </div>

  <div class="comment-input">
    <quill-editor v-model="newComment" placeholder="添加留言..." />
    <el-button type="primary" @click="submitComment">提交</el-button>
  </div>
</template>
```

## 9. 性能优化

### 9.1 数据库索引
- task_id, is_deleted (复合索引)
- user_id (用于查询用户留言历史)

### 9.2 分页加载
如果留言数量较多，可以实现分页或滚动加载

## 10. 测试用例

```python
def test_create_comment():
    """测试创建留言"""
    comment = CommentService.create_comment(
        task_id=1,
        user_id=2,
        content='这是一条测试留言'
    )
    assert comment.id is not None
    assert comment.content == '这是一条测试留言'

def test_update_comment():
    """测试更新留言"""
    comment = CommentService.update_comment(
        comment_id=1,
        user_id=2,  # 留言创建者
        content='修改后的内容'
    )
    assert comment.content == '修改后的内容'

def test_unauthorized_update():
    """测试无权限更新"""
    with pytest.raises(PermissionError):
        CommentService.update_comment(
            comment_id=1,
            user_id=999,  # 非创建者
            content='修改后的内容'
        )
```
