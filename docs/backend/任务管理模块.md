# 任务管理模块设计文档

## 1. 模块概述

任务管理模块是系统的核心模块，负责任务的全生命周期管理，包括创建、查询、更新、流转、状态变更等功能。

## 2. 核心功能

### 2.1 功能列表
- 任务创建
- 任务详情查询
- 任务列表查询(支持搜索、筛选、分页)
- 任务更新(标题、描述、进度等)
- 任务流转
- 任务响应
- 任务挂起/恢复
- 任务完成
- 任务关闭
- 任务导出
- 时间进度计算

## 3. 数据模型

### 3.1 Task模型

```python
from sqlalchemy import Column, Integer, String, Text, DateTime, ForeignKey, CheckConstraint
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from app.models.base import Base

class Task(Base):
    __tablename__ = 'tasks'

    id = Column(Integer, primary_key=True, autoincrement=True)
    title = Column(String(500), nullable=False)
    category = Column(String(50), nullable=False)
    description = Column(Text)
    status = Column(String(50), nullable=False, default='新建', index=True)
    progress = Column(Integer, default=0)
    time_progress = Column(Integer, default=0)

    creator_id = Column(Integer, ForeignKey('users.id'), nullable=False, index=True)
    current_handler_id = Column(Integer, ForeignKey('users.id'), nullable=False, index=True)

    expected_start_time = Column(DateTime)
    expected_end_time = Column(DateTime, index=True)
    actual_start_time = Column(DateTime)
    actual_end_time = Column(DateTime)

    created_at = Column(DateTime, default=func.now(), index=True)
    updated_at = Column(DateTime, default=func.now(), onupdate=func.now())

    # 关系
    creator = relationship('User', foreign_keys=[creator_id])
    current_handler = relationship('User', foreign_keys=[current_handler_id])
    transfers = relationship('TaskTransfer', back_populates='task', cascade='all, delete-orphan')
    comments = relationship('TaskComment', back_populates='task', cascade='all, delete-orphan')

    __table_args__ = (
        CheckConstraint('progress >= 0 AND progress <= 100', name='check_progress_range'),
        CheckConstraint('time_progress >= 0 AND time_progress <= 100', name='check_time_progress_range'),
        CheckConstraint("category IN ('版本任务', '紧急任务', '其他任务', '定时周期任务')", name='check_category'),
    )

    def to_dict(self, include_details=False):
        """转换为字典"""
        result = {
            'id': self.id,
            'title': self.title,
            'category': self.category,
            'status': self.status,
            'progress': self.progress,
            'time_progress': self.time_progress,
            'creator_id': self.creator_id,
            'creator_name': self.creator.name if self.creator else None,
            'current_handler_id': self.current_handler_id,
            'current_handler_name': self.current_handler.name if self.current_handler else None,
            'expected_start_time': self.expected_start_time.isoformat() if self.expected_start_time else None,
            'expected_end_time': self.expected_end_time.isoformat() if self.expected_end_time else None,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None,
        }

        if include_details:
            result.update({
                'description': self.description,
                'actual_start_time': self.actual_start_time.isoformat() if self.actual_start_time else None,
                'actual_end_time': self.actual_end_time.isoformat() if self.actual_end_time else None,
            })

        return result

    def calculate_time_progress(self):
        """计算时间进度"""
        if not self.expected_start_time or not self.expected_end_time:
            return 0

        from datetime import datetime
        now = datetime.now()

        if now < self.expected_start_time:
            return 0
        elif now > self.expected_end_time:
            return 100
        else:
            total_duration = (self.expected_end_time - self.expected_start_time).total_seconds()
            elapsed_duration = (now - self.expected_start_time).total_seconds()
            return int((elapsed_duration / total_duration) * 100)
```

## 4. 业务逻辑层

### 4.1 TaskService类

```python
from app.models.task import Task
from app.models.user import User
from app.utils.database import db_session
from datetime import datetime
from sqlalchemy import or_, and_

class TaskService:
    """任务业务逻辑服务"""

    # 任务状态常量
    STATUS_NEW = '新建'
    STATUS_PENDING = '待响应'
    STATUS_PROCESSING = '处理中'
    STATUS_SUSPENDED = '挂起'
    STATUS_COMPLETED = '已完成'
    STATUS_CLOSED = '关闭'

    # 任务分类常量
    CATEGORY_VERSION = '版本任务'
    CATEGORY_URGENT = '紧急任务'
    CATEGORY_OTHER = '其他任务'
    CATEGORY_PERIODIC = '定时周期任务'

    @staticmethod
    def create_task(title, category, description, creator_id, current_handler_id,
                    expected_start_time=None, expected_end_time=None):
        """
        创建任务
        :return: Task对象
        """
        # 验证用户存在
        creator = db_session.query(User).filter_by(id=creator_id).first()
        handler = db_session.query(User).filter_by(id=current_handler_id).first()

        if not creator or not handler:
            raise ValueError("创建人或处理人不存在")

        # 验证时间
        if expected_start_time and expected_end_time:
            if expected_end_time <= expected_start_time:
                raise ValueError("期望完成时间必须大于期望开始时间")

        task = Task(
            title=title,
            category=category,
            description=description,
            creator_id=creator_id,
            current_handler_id=current_handler_id,
            expected_start_time=expected_start_time,
            expected_end_time=expected_end_time,
            status=TaskService.STATUS_NEW
        )

        db_session.add(task)
        db_session.commit()

        # 创建初始流转记录(由触发器自动完成)

        return task

    @staticmethod
    def get_task_by_id(task_id):
        """根据ID获取任务"""
        return db_session.query(Task).filter_by(id=task_id).first()

    @staticmethod
    def update_task(task_id, user_id, **kwargs):
        """
        更新任务
        :param task_id: 任务ID
        :param user_id: 操作用户ID
        :param kwargs: 要更新的字段
        :return: Task对象
        """
        task = TaskService.get_task_by_id(task_id)
        if not task:
            raise ValueError("任务不存在")

        # 权限检查
        user = db_session.query(User).filter_by(id=user_id).first()
        if not user:
            raise ValueError("用户不存在")

        if not user.is_admin and task.current_handler_id != user_id:
            raise PermissionError("只有当前处理人或管理员可以更新任务")

        # 允许更新的字段
        allowed_fields = ['title', 'description', 'category', 'expected_start_time',
                          'expected_end_time', 'progress']

        for key, value in kwargs.items():
            if key in allowed_fields:
                setattr(task, key, value)

        db_session.commit()
        return task

    @staticmethod
    def transfer_task(task_id, operator_id, target_user_id, message=''):
        """
        流转任务
        :param task_id: 任务ID
        :param operator_id: 操作人ID
        :param target_user_id: 目标用户ID
        :param message: 流转留言
        :return: Task对象
        """
        from app.services.transfer_service import TransferService

        task = TaskService.get_task_by_id(task_id)
        if not task:
            raise ValueError("任务不存在")

        # 权限检查
        operator = db_session.query(User).filter_by(id=operator_id).first()
        target_user = db_session.query(User).filter_by(id=target_user_id).first()

        if not operator or not target_user:
            raise ValueError("操作人或目标用户不存在")

        if not operator.is_admin and task.current_handler_id != operator_id:
            raise PermissionError("只有当前处理人或管理员可以流转任务")

        # 更新任务
        task.current_handler_id = target_user_id
        task.status = TaskService.STATUS_PENDING

        # 创建流转记录
        TransferService.create_transfer(
            task_id=task_id,
            operator_id=operator_id,
            target_user_id=target_user_id,
            message=message,
            transfer_type='流转'
        )

        db_session.commit()
        return task

    @staticmethod
    def respond_task(task_id, user_id):
        """
        响应任务
        :param task_id: 任务ID
        :param user_id: 用户ID
        :return: Task对象
        """
        from app.services.transfer_service import TransferService

        task = TaskService.get_task_by_id(task_id)
        if not task:
            raise ValueError("任务不存在")

        if task.current_handler_id != user_id:
            raise PermissionError("只有当前处理人可以响应任务")

        if task.status not in [TaskService.STATUS_NEW, TaskService.STATUS_PENDING, TaskService.STATUS_SUSPENDED]:
            raise ValueError(f"任务当前状态({task.status})不允许响应")

        task.status = TaskService.STATUS_PROCESSING
        if not task.actual_start_time:
            task.actual_start_time = datetime.now()

        # 创建流转记录
        TransferService.create_transfer(
            task_id=task_id,
            operator_id=user_id,
            target_user_id=user_id,
            message='响应任务',
            transfer_type='响应'
        )

        db_session.commit()
        return task

    @staticmethod
    def suspend_task(task_id, user_id, message=''):
        """
        挂起任务
        :param task_id: 任务ID
        :param user_id: 用户ID
        :param message: 挂起原因
        :return: Task对象
        """
        from app.services.transfer_service import TransferService

        task = TaskService.get_task_by_id(task_id)
        if not task:
            raise ValueError("任务不存在")

        user = db_session.query(User).filter_by(id=user_id).first()
        if not user.is_admin and task.current_handler_id != user_id:
            raise PermissionError("只有当前处理人或管理员可以挂起任务")

        if task.status != TaskService.STATUS_PROCESSING:
            raise ValueError("只有处理中的任务可以挂起")

        task.status = TaskService.STATUS_SUSPENDED

        TransferService.create_transfer(
            task_id=task_id,
            operator_id=user_id,
            target_user_id=task.current_handler_id,
            message=message,
            transfer_type='挂起'
        )

        db_session.commit()
        return task

    @staticmethod
    def complete_task(task_id, user_id, message=''):
        """
        完成任务
        :param task_id: 任务ID
        :param user_id: 用户ID
        :param message: 完成说明
        :return: Task对象
        """
        from app.services.transfer_service import TransferService

        task = TaskService.get_task_by_id(task_id)
        if not task:
            raise ValueError("任务不存在")

        user = db_session.query(User).filter_by(id=user_id).first()
        if not user.is_admin and task.current_handler_id != user_id:
            raise PermissionError("只有当前处理人或管理员可以完成任务")

        task.status = TaskService.STATUS_COMPLETED
        task.progress = 100
        task.actual_end_time = datetime.now()

        TransferService.create_transfer(
            task_id=task_id,
            operator_id=user_id,
            target_user_id=task.current_handler_id,
            message=message,
            transfer_type='完成'
        )

        db_session.commit()
        return task

    @staticmethod
    def close_task(task_id, user_id, message=''):
        """
        关闭任务(管理员操作)
        :param task_id: 任务ID
        :param user_id: 管理员ID
        :param message: 关闭原因
        :return: Task对象
        """
        from app.services.transfer_service import TransferService

        task = TaskService.get_task_by_id(task_id)
        if not task:
            raise ValueError("任务不存在")

        user = db_session.query(User).filter_by(id=user_id).first()
        if not user.is_admin:
            raise PermissionError("只有管理员可以关闭任务")

        task.status = TaskService.STATUS_CLOSED

        TransferService.create_transfer(
            task_id=task_id,
            operator_id=user_id,
            target_user_id=task.current_handler_id,
            message=message,
            transfer_type='关闭'
        )

        db_session.commit()
        return task

    @staticmethod
    def list_tasks(page=1, per_page=20, **filters):
        """
        获取任务列表
        :param page: 页码
        :param per_page: 每页数量
        :param filters: 筛选条件
            - search: 搜索关键词(标题)
            - creator_id: 创建人ID
            - current_handler_id: 当前处理人ID
            - status: 状态
            - category: 分类
            - created_start: 创建时间起始
            - created_end: 创建时间结束
        :return: {'tasks': [], 'total': 0, 'page': 1, 'per_page': 20}
        """
        query = db_session.query(Task)

        # 搜索
        if 'search' in filters and filters['search']:
            search_pattern = f"%{filters['search']}%"
            query = query.filter(Task.title.ilike(search_pattern))

        # 筛选
        if 'creator_id' in filters and filters['creator_id']:
            query = query.filter(Task.creator_id == filters['creator_id'])

        if 'current_handler_id' in filters and filters['current_handler_id']:
            query = query.filter(Task.current_handler_id == filters['current_handler_id'])

        if 'status' in filters and filters['status']:
            query = query.filter(Task.status == filters['status'])

        if 'category' in filters and filters['category']:
            query = query.filter(Task.category == filters['category'])

        if 'created_start' in filters and filters['created_start']:
            query = query.filter(Task.created_at >= filters['created_start'])

        if 'created_end' in filters and filters['created_end']:
            query = query.filter(Task.created_at <= filters['created_end'])

        # 排序
        query = query.order_by(Task.created_at.desc())

        total = query.count()
        tasks = query.offset((page - 1) * per_page).limit(per_page).all()

        return {
            'tasks': [task.to_dict() for task in tasks],
            'total': total,
            'page': page,
            'per_page': per_page
        }

    @staticmethod
    def get_my_tasks(user_id, status_list=None):
        """
        获取我的任务(我是当前处理人)
        :param user_id: 用户ID
        :param status_list: 状态列表，如 ['待响应', '处理中']
        :return: Task列表
        """
        query = db_session.query(Task).filter(Task.current_handler_id == user_id)

        if status_list:
            query = query.filter(Task.status.in_(status_list))

        return query.order_by(Task.expected_end_time.asc()).all()

    @staticmethod
    def update_time_progress(task_id):
        """
        更新任务时间进度
        :param task_id: 任务ID
        """
        task = TaskService.get_task_by_id(task_id)
        if task:
            task.time_progress = task.calculate_time_progress()
            db_session.commit()

    @staticmethod
    def export_tasks(filters=None):
        """
        导出任务(返回DataFrame)
        :param filters: 筛选条件
        :return: pandas.DataFrame
        """
        import pandas as pd

        query = db_session.query(Task)

        # 应用筛选条件
        if filters:
            if 'status' in filters:
                query = query.filter(Task.status == filters['status'])
            # 其他筛选...

        tasks = query.all()

        data = []
        for task in tasks:
            data.append({
                '任务ID': task.id,
                '任务标题': task.title,
                '任务分类': task.category,
                '任务状态': task.status,
                '创建人': task.creator.name if task.creator else '',
                '当前处理人': task.current_handler.name if task.current_handler else '',
                '处理进度': f"{task.progress}%",
                '时间进度': f"{task.time_progress}%",
                '创建时间': task.created_at.strftime('%Y-%m-%d %H:%M:%S') if task.created_at else '',
                '期望开始时间': task.expected_start_time.strftime('%Y-%m-%d %H:%M:%S') if task.expected_start_time else '',
                '期望完成时间': task.expected_end_time.strftime('%Y-%m-%d %H:%M:%S') if task.expected_end_time else '',
            })

        return pd.DataFrame(data)
```

## 5. API接口层

### 5.1 RESTful API定义

#### 5.1.1 创建任务
```
POST /api/tasks
Authorization: Bearer <token>
Content-Type: application/json

Request:
{
    "title": "实现用户登录功能",
    "category": "版本任务",
    "description": "需要实现用户登录、JWT认证等功能",
    "current_handler_id": 2,
    "expected_start_time": "2025-01-20T09:00:00",
    "expected_end_time": "2025-01-25T18:00:00"
}

Response:
{
    "code": 0,
    "message": "任务创建成功",
    "data": {
        "id": 1,
        "title": "实现用户登录功能",
        ...
    }
}
```

#### 5.1.2 获取任务列表
```
GET /api/tasks?page=1&per_page=20&status=处理中&current_handler_id=2
Authorization: Bearer <token>

Response:
{
    "code": 0,
    "message": "success",
    "data": {
        "tasks": [...],
        "total": 50,
        "page": 1,
        "per_page": 20
    }
}
```

#### 5.1.3 获取任务详情
```
GET /api/tasks/{task_id}
Authorization: Bearer <token>

Response:
{
    "code": 0,
    "message": "success",
    "data": {
        "id": 1,
        "title": "实现用户登录功能",
        "description": "...",
        "status": "处理中",
        ...
    }
}
```

#### 5.1.4 更新任务
```
PUT /api/tasks/{task_id}
Authorization: Bearer <token>
Content-Type: application/json

Request:
{
    "title": "实现用户登录和注册功能",
    "progress": 60
}

Response:
{
    "code": 0,
    "message": "任务更新成功",
    "data": {...}
}
```

#### 5.1.5 流转任务
```
POST /api/tasks/{task_id}/transfer
Authorization: Bearer <token>
Content-Type: application/json

Request:
{
    "target_user_id": 3,
    "message": "请协助处理登录模块"
}

Response:
{
    "code": 0,
    "message": "任务流转成功",
    "data": {...}
}
```

#### 5.1.6 响应任务
```
POST /api/tasks/{task_id}/respond
Authorization: Bearer <token>

Response:
{
    "code": 0,
    "message": "任务已响应",
    "data": {...}
}
```

#### 5.1.7 挂起任务
```
POST /api/tasks/{task_id}/suspend
Authorization: Bearer <token>
Content-Type: application/json

Request:
{
    "message": "等待第三方接口文档"
}

Response:
{
    "code": 0,
    "message": "任务已挂起",
    "data": {...}
}
```

#### 5.1.8 完成任务
```
POST /api/tasks/{task_id}/complete
Authorization: Bearer <token>
Content-Type: application/json

Request:
{
    "message": "功能已开发完成并测试通过"
}

Response:
{
    "code": 0,
    "message": "任务已完成",
    "data": {...}
}
```

#### 5.1.9 导出任务
```
GET /api/tasks/export?status=已完成&format=excel
Authorization: Bearer <token>

Response:
Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
Content-Disposition: attachment; filename=tasks_20250115.xlsx

[Excel文件内容]
```

## 6. 状态流转图

```
     创建
      ↓
    新建
      ↓ (流转)
   待响应
      ↓ (响应)
    处理中 ←→ 挂起
      ↓ (完成)
    已完成
      ↓ (关闭)
     关闭
```

## 7. 权限控制矩阵

| 操作 | 创建人 | 当前处理人 | 其他用户 | 管理员 |
|-----|--------|-----------|---------|--------|
| 查看任务 | ✓ | ✓ | ✓ | ✓ |
| 更新任务 | ✗ | ✓ | ✗ | ✓ |
| 流转任务 | ✗ | ✓ | ✗ | ✓ |
| 响应任务 | ✗ | ✓ | ✗ | ✗ |
| 挂起任务 | ✗ | ✓ | ✗ | ✓ |
| 完成任务 | ✗ | ✓ | ✗ | ✓ |
| 关闭任务 | ✗ | ✗ | ✗ | ✓ |
| 留言 | ✓ | ✓ | ✓ | ✓ |

## 8. 性能优化

### 8.1 数据库索引
- status, current_handler_id, expected_end_time (复合索引)
- created_at (降序索引)
- title (GIN全文搜索索引)

### 8.2 查询优化
- 使用join避免N+1查询
- 列表查询不加载description等大字段
- 分页查询

### 8.3 缓存策略
- 热门任务详情缓存(Redis)
- 缓存键: `task:{task_id}`
- 缓存时间: 5分钟
- 任务更新时清除缓存

## 9. 测试用例

```python
def test_create_task():
    """测试创建任务"""
    task = TaskService.create_task(
        title='测试任务',
        category='其他任务',
        description='测试描述',
        creator_id=1,
        current_handler_id=2
    )
    assert task.id is not None
    assert task.status == '新建'

def test_transfer_task():
    """测试流转任务"""
    task = TaskService.transfer_task(
        task_id=1,
        operator_id=2,
        target_user_id=3,
        message='流转给张三'
    )
    assert task.current_handler_id == 3
    assert task.status == '待响应'

def test_unauthorized_transfer():
    """测试无权限流转"""
    with pytest.raises(PermissionError):
        TaskService.transfer_task(
            task_id=1,
            operator_id=999,  # 非当前处理人
            target_user_id=3
        )
```
