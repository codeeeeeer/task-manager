# 流转记录模块设计文档

## 1. 模块概述

流转记录模块负责记录任务的所有流转历史，包括创建、流转、响应、挂起、完成、关闭等操作记录。

## 2. 核心功能

- 创建流转记录
- 查询任务的流转历史
- 统计流转次数
- 流转时间轴展示

## 3. 数据模型

### 3.1 TaskTransfer模型

```python
from sqlalchemy import Column, Integer, String, Text, DateTime, ForeignKey
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from app.models.base import Base

class TaskTransfer(Base):
    __tablename__ = 'task_transfers'

    id = Column(Integer, primary_key=True, autoincrement=True)
    task_id = Column(Integer, ForeignKey('tasks.id', ondelete='CASCADE'), nullable=False, index=True)
    operator_id = Column(Integer, ForeignKey('users.id'), nullable=False)
    target_user_id = Column(Integer, ForeignKey('users.id'), nullable=False)
    message = Column(Text)
    transfer_type = Column(String(50), default='流转', nullable=False)
    created_at = Column(DateTime, default=func.now(), index=True)

    # 关系
    task = relationship('Task', back_populates='transfers')
    operator = relationship('User', foreign_keys=[operator_id])
    target_user = relationship('User', foreign_keys=[target_user_id])

    def to_dict(self):
        """转换为字典"""
        return {
            'id': self.id,
            'task_id': self.task_id,
            'operator_id': self.operator_id,
            'operator_name': self.operator.name if self.operator else None,
            'target_user_id': self.target_user_id,
            'target_user_name': self.target_user.name if self.target_user else None,
            'message': self.message,
            'transfer_type': self.transfer_type,
            'created_at': self.created_at.isoformat() if self.created_at else None
        }
```

## 4. 业务逻辑层

### 4.1 TransferService类

```python
from app.models.task_transfer import TaskTransfer
from app.utils.database import db_session

class TransferService:
    """流转记录业务逻辑服务"""

    # 流转类型常量
    TYPE_CREATE = '创建'
    TYPE_TRANSFER = '流转'
    TYPE_RESPOND = '响应'
    TYPE_SUSPEND = '挂起'
    TYPE_RESUME = '恢复'
    TYPE_COMPLETE = '完成'
    TYPE_CLOSE = '关闭'

    @staticmethod
    def create_transfer(task_id, operator_id, target_user_id, message='', transfer_type='流转'):
        """
        创建流转记录
        :param task_id: 任务ID
        :param operator_id: 操作人ID
        :param target_user_id: 目标用户ID
        :param message: 流转留言
        :param transfer_type: 流转类型
        :return: TaskTransfer对象
        """
        transfer = TaskTransfer(
            task_id=task_id,
            operator_id=operator_id,
            target_user_id=target_user_id,
            message=message,
            transfer_type=transfer_type
        )

        db_session.add(transfer)
        db_session.commit()

        return transfer

    @staticmethod
    def get_task_transfers(task_id):
        """
        获取任务的所有流转记录
        :param task_id: 任务ID
        :return: TaskTransfer列表
        """
        transfers = db_session.query(TaskTransfer)\
            .filter_by(task_id=task_id)\
            .order_by(TaskTransfer.created_at.asc())\
            .all()

        return [transfer.to_dict() for transfer in transfers]

    @staticmethod
    def get_transfer_count(task_id):
        """
        获取任务流转次数
        :param task_id: 任务ID
        :return: 流转次数
        """
        return db_session.query(TaskTransfer)\
            .filter_by(task_id=task_id, transfer_type=TransferService.TYPE_TRANSFER)\
            .count()

    @staticmethod
    def get_latest_transfer(task_id):
        """
        获取任务最新的流转记录
        :param task_id: 任务ID
        :return: TaskTransfer对象或None
        """
        transfer = db_session.query(TaskTransfer)\
            .filter_by(task_id=task_id)\
            .order_by(TaskTransfer.created_at.desc())\
            .first()

        return transfer.to_dict() if transfer else None

    @staticmethod
    def get_user_operation_history(user_id, limit=50):
        """
        获取用户的操作历史
        :param user_id: 用户ID
        :param limit: 返回数量
        :return: TaskTransfer列表
        """
        transfers = db_session.query(TaskTransfer)\
            .filter_by(operator_id=user_id)\
            .order_by(TaskTransfer.created_at.desc())\
            .limit(limit)\
            .all()

        return [transfer.to_dict() for transfer in transfers]

    @staticmethod
    def get_transfer_timeline(task_id):
        """
        获取任务流转时间轴(用于前端展示)
        :param task_id: 任务ID
        :return: 时间轴数据
        """
        transfers = db_session.query(TaskTransfer)\
            .filter_by(task_id=task_id)\
            .order_by(TaskTransfer.created_at.asc())\
            .all()

        timeline = []
        for transfer in transfers:
            # 根据流转类型设置图标和颜色
            icon_map = {
                TransferService.TYPE_CREATE: {'icon': 'plus', 'color': 'blue'},
                TransferService.TYPE_TRANSFER: {'icon': 'share', 'color': 'orange'},
                TransferService.TYPE_RESPOND: {'icon': 'check', 'color': 'green'},
                TransferService.TYPE_SUSPEND: {'icon': 'pause', 'color': 'gray'},
                TransferService.TYPE_RESUME: {'icon': 'play', 'color': 'blue'},
                TransferService.TYPE_COMPLETE: {'icon': 'check-circle', 'color': 'green'},
                TransferService.TYPE_CLOSE: {'icon': 'close-circle', 'color': 'red'},
            }

            timeline.append({
                'id': transfer.id,
                'timestamp': transfer.created_at.isoformat(),
                'type': transfer.transfer_type,
                'operator': transfer.operator.name if transfer.operator else '未知',
                'target': transfer.target_user.name if transfer.target_user else '未知',
                'message': transfer.message,
                'icon': icon_map.get(transfer.transfer_type, {}).get('icon', 'dot'),
                'color': icon_map.get(transfer.transfer_type, {}).get('color', 'gray')
            })

        return timeline
```

## 5. API接口层

### 5.1 RESTful API定义

#### 5.1.1 获取任务流转记录
```
GET /api/tasks/{task_id}/transfers
Authorization: Bearer <token>

Response:
{
    "code": 0,
    "message": "success",
    "data": [
        {
            "id": 1,
            "task_id": 1,
            "operator_id": 1,
            "operator_name": "张三",
            "target_user_id": 2,
            "target_user_name": "李四",
            "message": "任务创建",
            "transfer_type": "创建",
            "created_at": "2025-01-15T10:00:00"
        },
        {
            "id": 2,
            "task_id": 1,
            "operator_id": 2,
            "operator_name": "李四",
            "target_user_id": 3,
            "target_user_name": "王五",
            "message": "请协助处理",
            "transfer_type": "流转",
            "created_at": "2025-01-16T14:30:00"
        }
    ]
}
```

#### 5.1.2 获取任务流转时间轴
```
GET /api/tasks/{task_id}/timeline
Authorization: Bearer <token>

Response:
{
    "code": 0,
    "message": "success",
    "data": [
        {
            "id": 1,
            "timestamp": "2025-01-15T10:00:00",
            "type": "创建",
            "operator": "张三",
            "target": "李四",
            "message": "任务创建",
            "icon": "plus",
            "color": "blue"
        },
        ...
    ]
}
```

## 6. 前端展示建议

### 6.1 时间轴组件(Element Plus Timeline)

```vue
<template>
  <el-timeline>
    <el-timeline-item
      v-for="item in timeline"
      :key="item.id"
      :timestamp="formatTime(item.timestamp)"
      :color="item.color"
      :icon="item.icon"
    >
      <div class="transfer-content">
        <div class="transfer-header">
          <span class="transfer-type">{{ item.type }}</span>
          <span class="operator">{{ item.operator }}</span>
          <span v-if="item.type === '流转'">
            → {{ item.target }}
          </span>
        </div>
        <div v-if="item.message" class="transfer-message">
          {{ item.message }}
        </div>
      </div>
    </el-timeline-item>
  </el-timeline>
</template>
```

## 7. 性能优化

### 7.1 数据库索引
- task_id (用于快速查询任务的所有流转记录)
- created_at (用于时间排序)

### 7.2 查询优化
- 使用join预加载operator和target_user，避免N+1查询
- 流转记录通常不会很多，可以一次性加载所有记录

## 8. 测试用例

```python
def test_create_transfer():
    """测试创建流转记录"""
    transfer = TransferService.create_transfer(
        task_id=1,
        operator_id=1,
        target_user_id=2,
        message='任务创建',
        transfer_type='创建'
    )
    assert transfer.id is not None

def test_get_task_transfers():
    """测试获取任务流转记录"""
    transfers = TransferService.get_task_transfers(task_id=1)
    assert len(transfers) > 0
    assert transfers[0]['transfer_type'] == '创建'

def test_transfer_timeline():
    """测试流转时间轴"""
    timeline = TransferService.get_transfer_timeline(task_id=1)
    assert isinstance(timeline, list)
    for item in timeline:
        assert 'icon' in item
        assert 'color' in item
```
