# 用户管理模块设计文档

## 1. 模块概述

用户管理模块负责系统中所有用户相关的操作，包括用户注册、登录、权限验证、用户信息管理以及批量导入等功能。

## 2. 核心功能

### 2.1 功能列表
- 用户登录认证
- 用户信息CRUD
- 批量导入用户(Excel/CSV)
- 用户权限验证
- 密码管理(修改密码)
- 用户搜索与列表

## 3. 数据模型

### 3.1 User模型

```python
from sqlalchemy import Column, Integer, String, Boolean, DateTime
from sqlalchemy.sql import func
from app.models.base import Base

class User(Base):
    __tablename__ = 'users'

    id = Column(Integer, primary_key=True, autoincrement=True)
    um_code = Column(String(50), unique=True, nullable=False, index=True)
    name = Column(String(100), nullable=False)
    email = Column(String(255), unique=True, nullable=False, index=True)
    password_hash = Column(String(255), nullable=False)
    is_admin = Column(Boolean, default=False)
    is_active = Column(Boolean, default=True, index=True)
    created_at = Column(DateTime, default=func.now())
    updated_at = Column(DateTime, default=func.now(), onupdate=func.now())
    last_login_at = Column(DateTime, nullable=True)

    def to_dict(self, exclude_password=True):
        """转换为字典，默认排除密码"""
        result = {
            'id': self.id,
            'um_code': self.um_code,
            'name': self.name,
            'email': self.email,
            'is_admin': self.is_admin,
            'is_active': self.is_active,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'last_login_at': self.last_login_at.isoformat() if self.last_login_at else None
        }
        if not exclude_password:
            result['password_hash'] = self.password_hash
        return result

    def check_password(self, password):
        """验证密码"""
        from werkzeug.security import check_password_hash
        return check_password_hash(self.password_hash, password)

    @staticmethod
    def hash_password(password):
        """密码哈希"""
        from werkzeug.security import generate_password_hash
        return generate_password_hash(password)
```

## 4. 业务逻辑层

### 4.1 UserService类

```python
from app.models.user import User
from app.utils.database import db_session
from sqlalchemy.exc import IntegrityError
import pandas as pd

class UserService:
    """用户业务逻辑服务"""

    @staticmethod
    def authenticate(email, password):
        """
        用户认证
        :param email: 邮箱
        :param password: 密码
        :return: User对象或None
        """
        user = db_session.query(User).filter_by(email=email, is_active=True).first()
        if user and user.check_password(password):
            # 更新最后登录时间
            user.last_login_at = func.now()
            db_session.commit()
            return user
        return None

    @staticmethod
    def create_user(um_code, name, email, password, is_admin=False):
        """
        创建用户
        :return: User对象
        :raises: ValueError
        """
        try:
            user = User(
                um_code=um_code,
                name=name,
                email=email,
                password_hash=User.hash_password(password),
                is_admin=is_admin
            )
            db_session.add(user)
            db_session.commit()
            return user
        except IntegrityError as e:
            db_session.rollback()
            if 'um_code' in str(e.orig):
                raise ValueError(f"用户编号 {um_code} 已存在")
            elif 'email' in str(e.orig):
                raise ValueError(f"邮箱 {email} 已被注册")
            else:
                raise ValueError("创建用户失败")

    @staticmethod
    def get_user_by_id(user_id):
        """根据ID获取用户"""
        return db_session.query(User).filter_by(id=user_id, is_active=True).first()

    @staticmethod
    def get_user_by_um_code(um_code):
        """根据UM编号获取用户"""
        return db_session.query(User).filter_by(um_code=um_code, is_active=True).first()

    @staticmethod
    def update_user(user_id, **kwargs):
        """
        更新用户信息
        :param user_id: 用户ID
        :param kwargs: 要更新的字段
        :return: User对象
        """
        user = UserService.get_user_by_id(user_id)
        if not user:
            raise ValueError("用户不存在")

        allowed_fields = ['name', 'email', 'is_admin', 'is_active']
        for key, value in kwargs.items():
            if key in allowed_fields:
                setattr(user, key, value)

        try:
            db_session.commit()
            return user
        except IntegrityError:
            db_session.rollback()
            raise ValueError("更新失败，邮箱可能已被使用")

    @staticmethod
    def change_password(user_id, old_password, new_password):
        """修改密码"""
        user = UserService.get_user_by_id(user_id)
        if not user:
            raise ValueError("用户不存在")

        if not user.check_password(old_password):
            raise ValueError("原密码错误")

        user.password_hash = User.hash_password(new_password)
        db_session.commit()
        return True

    @staticmethod
    def reset_password(user_id, new_password):
        """
        重置密码(管理员操作)
        :param user_id: 用户ID
        :param new_password: 新密码
        """
        user = UserService.get_user_by_id(user_id)
        if not user:
            raise ValueError("用户不存在")

        user.password_hash = User.hash_password(new_password)
        db_session.commit()
        return True

    @staticmethod
    def delete_user(user_id):
        """软删除用户"""
        user = UserService.get_user_by_id(user_id)
        if not user:
            raise ValueError("用户不存在")

        user.is_active = False
        db_session.commit()
        return True

    @staticmethod
    def list_users(page=1, per_page=20, search=None, is_admin=None):
        """
        获取用户列表
        :param page: 页码
        :param per_page: 每页数量
        :param search: 搜索关键词(姓名、邮箱、UM编号)
        :param is_admin: 筛选管理员
        :return: {'users': [], 'total': 0, 'page': 1, 'per_page': 20}
        """
        query = db_session.query(User).filter_by(is_active=True)

        if search:
            search_pattern = f"%{search}%"
            query = query.filter(
                (User.name.ilike(search_pattern)) |
                (User.email.ilike(search_pattern)) |
                (User.um_code.ilike(search_pattern))
            )

        if is_admin is not None:
            query = query.filter_by(is_admin=is_admin)

        total = query.count()
        users = query.offset((page - 1) * per_page).limit(per_page).all()

        return {
            'users': [user.to_dict() for user in users],
            'total': total,
            'page': page,
            'per_page': per_page
        }

    @staticmethod
    def import_users_from_file(file_path, file_type='csv'):
        """
        从文件批量导入用户
        :param file_path: 文件路径
        :param file_type: 文件类型 csv 或 excel
        :return: {'success': 5, 'failed': 2, 'errors': [...]}
        """
        # 读取文件
        if file_type == 'csv':
            df = pd.read_csv(file_path)
        else:  # excel
            df = pd.read_excel(file_path)

        # 验证必需列
        required_columns = ['um_code', 'name', 'email', 'password']
        if not all(col in df.columns for col in required_columns):
            raise ValueError(f"文件缺少必需列: {required_columns}")

        success_count = 0
        failed_count = 0
        errors = []

        for index, row in df.iterrows():
            try:
                is_admin = row.get('is_admin', False)
                if isinstance(is_admin, str):
                    is_admin = is_admin.lower() in ['true', '1', 'yes', '是']

                UserService.create_user(
                    um_code=str(row['um_code']).strip(),
                    name=str(row['name']).strip(),
                    email=str(row['email']).strip(),
                    password=str(row['password']).strip(),
                    is_admin=is_admin
                )
                success_count += 1
            except Exception as e:
                failed_count += 1
                errors.append({
                    'row': index + 2,  # Excel行号从1开始，还有表头
                    'data': row.to_dict(),
                    'error': str(e)
                })

        return {
            'success': success_count,
            'failed': failed_count,
            'errors': errors
        }
```

## 5. API接口层

### 5.1 RESTful API定义

#### 5.1.1 用户登录
```
POST /api/auth/login
Content-Type: application/json

Request:
{
    "email": "user@example.com",
    "password": "password123"
}

Response (成功):
{
    "code": 0,
    "message": "登录成功",
    "data": {
        "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "user": {
            "id": 1,
            "um_code": "UM001",
            "name": "张三",
            "email": "user@example.com",
            "is_admin": false
        }
    }
}

Response (失败):
{
    "code": 401,
    "message": "邮箱或密码错误",
    "data": null
}
```

#### 5.1.2 创建用户(管理员)
```
POST /api/users
Authorization: Bearer <token>
Content-Type: application/json

Request:
{
    "um_code": "UM002",
    "name": "李四",
    "email": "lisi@example.com",
    "password": "password123",
    "is_admin": false
}

Response:
{
    "code": 0,
    "message": "用户创建成功",
    "data": {
        "id": 2,
        "um_code": "UM002",
        "name": "李四",
        "email": "lisi@example.com",
        "is_admin": false
    }
}
```

#### 5.1.3 获取用户列表
```
GET /api/users?page=1&per_page=20&search=张三&is_admin=false
Authorization: Bearer <token>

Response:
{
    "code": 0,
    "message": "success",
    "data": {
        "users": [...],
        "total": 50,
        "page": 1,
        "per_page": 20
    }
}
```

#### 5.1.4 获取用户详情
```
GET /api/users/{user_id}
Authorization: Bearer <token>

Response:
{
    "code": 0,
    "message": "success",
    "data": {
        "id": 1,
        "um_code": "UM001",
        "name": "张三",
        ...
    }
}
```

#### 5.1.5 更新用户信息
```
PUT /api/users/{user_id}
Authorization: Bearer <token>
Content-Type: application/json

Request:
{
    "name": "张三丰",
    "email": "new@example.com"
}

Response:
{
    "code": 0,
    "message": "更新成功",
    "data": {...}
}
```

#### 5.1.6 修改密码
```
POST /api/users/{user_id}/change-password
Authorization: Bearer <token>
Content-Type: application/json

Request:
{
    "old_password": "old123",
    "new_password": "new123"
}

Response:
{
    "code": 0,
    "message": "密码修改成功",
    "data": null
}
```

#### 5.1.7 批量导入用户
```
POST /api/users/import
Authorization: Bearer <token>
Content-Type: multipart/form-data

Request:
- file: users.csv 或 users.xlsx

Response:
{
    "code": 0,
    "message": "导入完成",
    "data": {
        "success": 48,
        "failed": 2,
        "errors": [
            {"row": 5, "error": "邮箱已存在"},
            {"row": 10, "error": "UM编号已存在"}
        ]
    }
}
```

#### 5.1.8 删除用户(软删除)
```
DELETE /api/users/{user_id}
Authorization: Bearer <token>

Response:
{
    "code": 0,
    "message": "用户已删除",
    "data": null
}
```

## 6. 权限控制

### 6.1 JWT认证装饰器

```python
from functools import wraps
from flask import request, jsonify
from flask_jwt_extended import verify_jwt_in_request, get_jwt_identity

def login_required(fn):
    """登录认证装饰器"""
    @wraps(fn)
    def wrapper(*args, **kwargs):
        verify_jwt_in_request()
        return fn(*args, **kwargs)
    return wrapper

def admin_required(fn):
    """管理员权限装饰器"""
    @wraps(fn)
    def wrapper(*args, **kwargs):
        verify_jwt_in_request()
        user_id = get_jwt_identity()
        user = UserService.get_user_by_id(user_id)
        if not user or not user.is_admin:
            return jsonify({
                'code': 403,
                'message': '需要管理员权限',
                'data': None
            }), 403
        return fn(*args, **kwargs)
    return wrapper
```

### 6.2 权限矩阵

| 功能 | 普通用户 | 管理员 |
|-----|---------|--------|
| 登录 | ✓ | ✓ |
| 查看自己信息 | ✓ | ✓ |
| 修改自己信息 | ✓ | ✓ |
| 修改自己密码 | ✓ | ✓ |
| 创建用户 | ✗ | ✓ |
| 查看所有用户 | ✗ | ✓ |
| 修改其他用户 | ✗ | ✓ |
| 删除用户 | ✗ | ✓ |
| 批量导入 | ✗ | ✓ |
| 重置密码 | ✗ | ✓ |

## 7. 批量导入文件格式

### 7.1 CSV格式示例

```csv
um_code,name,email,password,is_admin
UM001,张三,zhangsan@example.com,password123,false
UM002,李四,lisi@example.com,password456,false
UM003,管理员,admin@example.com,admin123,true
```

### 7.2 Excel格式示例

| um_code | name | email | password | is_admin |
|---------|------|-------|----------|----------|
| UM001 | 张三 | zhangsan@example.com | password123 | false |
| UM002 | 李四 | lisi@example.com | password456 | false |

## 8. 错误处理

### 8.1 错误码定义

| 错误码 | 说明 |
|-------|------|
| 400 | 请求参数错误 |
| 401 | 未认证或认证失败 |
| 403 | 权限不足 |
| 404 | 用户不存在 |
| 409 | 用户已存在(邮箱或UM编号冲突) |
| 500 | 服务器内部错误 |

## 9. 测试用例

### 9.1 单元测试示例

```python
import unittest
from app.services.user_service import UserService

class TestUserService(unittest.TestCase):

    def test_create_user_success(self):
        """测试创建用户成功"""
        user = UserService.create_user(
            um_code='UM_TEST_001',
            name='测试用户',
            email='test@example.com',
            password='test123'
        )
        self.assertIsNotNone(user)
        self.assertEqual(user.um_code, 'UM_TEST_001')

    def test_create_duplicate_user(self):
        """测试创建重复用户"""
        with self.assertRaises(ValueError):
            UserService.create_user(
                um_code='UM001',  # 已存在
                name='重复用户',
                email='duplicate@example.com',
                password='test123'
            )

    def test_authenticate_success(self):
        """测试认证成功"""
        user = UserService.authenticate('admin@example.com', 'admin123')
        self.assertIsNotNone(user)
        self.assertTrue(user.is_admin)

    def test_authenticate_fail(self):
        """测试认证失败"""
        user = UserService.authenticate('admin@example.com', 'wrongpassword')
        self.assertIsNone(user)
```

## 10. 性能优化

### 10.1 查询优化
- 使用索引: um_code, email, is_active
- 避免SELECT *，只查询需要的字段
- 分页查询，避免一次性加载大量数据

### 10.2 缓存策略
- 用户信息缓存(Redis): 缓存时间30分钟
- 缓存键格式: `user:{user_id}` 或 `user:um:{um_code}`

## 11. 日志记录

记录以下关键操作：
- 用户登录(成功/失败)
- 用户创建
- 用户删除
- 密码修改
- 权限变更

日志格式:
```
[2025-01-15 10:30:45] [INFO] User login success: user_id=1, email=admin@example.com, ip=192.168.1.100
[2025-01-15 10:35:20] [INFO] User created: user_id=5, um_code=UM005, creator=1
```
